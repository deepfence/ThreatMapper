FROM golang:1.19-alpine3.16 AS build


RUN apk add --no-cache git build-base libpcap-dev libcap-dev

ADD deepfence_server /go/deepfence_server/
ADD deepfence_worker /go/deepfence_worker/
ADD deepfence_utils /go/deepfence_utils/
ADD deepfence_server_client /go/deepfence_server_client/
ADD deepfence_ingester /go/deepfence_ingester
RUN mkdir -p /go/deepfence_agent/tools/apache
ADD deepfence_agent/tools/apache /go/deepfence_agent/tools/apache
WORKDIR /go/deepfence_server/
# "make vendor" is run before separately to avoid docker cache invalidation
RUN make deepfence_server

FROM alpine:3.16
MAINTAINER Deepfence Inc
LABEL deepfence.role=system

ENV DEEPFENCE_POSTGRES_USER_DB_HOST=deepfence-postgres \
    DEEPFENCE_POSTGRES_USER_DB_PORT=5432 \
    DEEPFENCE_POSTGRES_USER_DB_USER=deepfence \
    DEEPFENCE_POSTGRES_USER_DB_PASSWORD=deepfence \
    DEEPFENCE_POSTGRES_USER_DB_NAME=users \
    DEEPFENCE_POSTGRES_USER_DB_SSLMODE=disable \
    DEEPFENCE_REDIS_HOST=deepfence-redis \
    DEEPFENCE_REDIS_PORT=6379 \
    DEEPFENCE_REDIS_DB_NUMBER=0 \
    DEEPFENCE_NEO4J_HOST=deepfence-neo4j \
    DEEPFENCE_NEO4J_BOLT_PORT=7687 \
    DEEPFENCE_NEO4J_USER=neo4j \
    DEEPFENCE_NEO4J_PASSWORD=password \
    DEEPFENCE_MINIO_HOST=deepfence-file-server \
    DEEPFENCE_MINIO_PORT=9000 \
    DEEPFENCE_MINIO_USER=deepfence \
    DEEPFENCE_MINIO_PASSWORD=deepfence \
    DEEPFENCE_MINIO_BUCKET=deepfence \
    DEEPFENCE_MINIO_SECURE=false \
    DEEPFENCE_HTTP_LISTEN_ENDPOINT=8080 \
    DEEPFENCE_SAAS_DEPLOYMENT=false \
    DEEPFENCE_KAFKA_BROKERS=deepfence-kafka-broker:9092

ADD deepfence_server/auth /auth
ADD deepfence_utils/postgresql /usr/local/postgresql-migrate
COPY deepfence_server/entrypoint.sh /entrypoint.sh
RUN apk add --no-cache --update bash curl libpcap tar kafkacat
RUN apk add --no-cache postgresql-client --repository=https://dl-cdn.alpinelinux.org/alpine/v3.14/main
RUN chmod +x /entrypoint.sh
RUN curl -L "https://github.com/golang-migrate/migrate/releases/latest/download/migrate.linux-amd64.tar.gz" | tar xvz
RUN mv migrate /usr/local/bin/migrate
RUN chmod +x /usr/local/bin/migrate
RUN cd /usr/local/share/
RUN wget https://github.com/swagger-api/swagger-ui/archive/refs/tags/v4.15.5.tar.gz -O /usr/local/share/swagger-ui.tar.gz
RUN tar -xzf /usr/local/share/swagger-ui.tar.gz -C /usr/local/share/
RUN mv /usr/local/share/swagger-ui-4.15.5/dist /usr/local/share/swagger-ui
RUN rm -rf /usr/local/share/swagger-ui.tar.gz /usr/local/share/swagger-ui-4.15.5

COPY --from=build /go/deepfence_server/deepfence_server /usr/local/bin/deepfence_server

EXPOSE 8080
ENTRYPOINT ["/entrypoint.sh"]
CMD ["/usr/local/bin/deepfence_server"]
