import { cloneDeepWith } from 'lodash-es';
import { useEffect, useState } from 'react';
import {
  ActionFunctionArgs,
  generatePath,
  Navigate,
  redirect,
  useActionData,
  useFetcher,
  useLocation,
  useNavigation,
} from 'react-router-dom';
import { Button, Checkbox, Switch, Tooltip, Typography } from 'ui-components';

import { getVulnerabilityApiClient } from '@/api/api';
import {
  ApiDocsBadRequestResponse,
  ModelNodeIdentifierNodeTypeEnum,
  ModelVulnerabilityScanConfigLanguage,
  ModelVulnerabilityScanConfigLanguageLanguageEnum,
  ModelVulnerabilityScanTriggerReq,
} from '@/api/generated';
import { ConnectorHeader } from '@/features/onboard/components/ConnectorHeader';
import { OnboardConnectionNode } from '@/features/onboard/pages/connectors/MyConnectors';
import { ApiError, makeRequest } from '@/utils/api';
import { usePageNavigation } from '@/utils/usePageNavigation';

export type ScanActionReturnType = {
  message?: string;
};

const action = async ({ request }: ActionFunctionArgs): Promise<ScanActionReturnType> => {
  const formData = await request.formData();
  const nodeIds = formData.get('_nodeIds')?.toString().split(',') ?? [];
  const nodeType = formData.get('_nodeType')?.toString() ?? '';
  const selectAll = formData.get('selectAll')?.toString() ?? '';
  const packages = formData.getAll(
    'packages',
  ) as unknown as ModelVulnerabilityScanConfigLanguage[];

  const requestBody: ModelVulnerabilityScanTriggerReq = {
    filters: {
      cloud_account_scan_filter: { filter_in: null },
      kubernetes_cluster_scan_filter: { filter_in: null },
      container_scan_filter: { filter_in: null },
      host_scan_filter: { filter_in: null },
      image_scan_filter: { filter_in: null },
    },
    node_ids: nodeIds.map((nodeId) => ({
      node_id: nodeId,
      node_type: (nodeType === 'kubernetes_cluster'
        ? 'cluster'
        : nodeType) as ModelNodeIdentifierNodeTypeEnum,
    })),
    scan_config:
      selectAll === 'all'
        ? ([
            ModelVulnerabilityScanConfigLanguageLanguageEnum.All,
          ] as unknown as ModelVulnerabilityScanConfigLanguage[])
        : packages,
  };

  const r = await makeRequest({
    apiFunction: getVulnerabilityApiClient().startVulnerabilityScan,
    apiArgs: [
      {
        modelVulnerabilityScanTriggerReq: requestBody,
      },
    ],
    errorHandler: async (r) => {
      const error = new ApiError<ScanActionReturnType>({});
      if (r.status === 400 || r.status === 409) {
        const modelResponse: ApiDocsBadRequestResponse = await r.json();
        return error.set({
          message: modelResponse.message ?? '',
        });
      }
    },
  });

  if (ApiError.isApiError(r)) {
    return r.value();
  }

  throw redirect(
    generatePath('/onboard/scan/view-summary/running/:nodeType/:scanType/:bulkScanId', {
      nodeType,
      scanType: 'vulnerability',
      bulkScanId: r.bulk_scan_id,
    }),
    302,
  );
};

const packages = [
  // {
  //   name: 'OS Packages',
  //   checked: false,
  //   value: ModelVulnerabilityScanTriggerReqScanConfigEnum.Base,
  // },
  {
    name: 'Java',
    checked: false,
    value: ModelVulnerabilityScanConfigLanguageLanguageEnum.Java,
  },
  {
    name: 'Javascript',
    checked: false,
    value: ModelVulnerabilityScanConfigLanguageLanguageEnum.Javascript,
  },
  {
    name: 'Rust',
    checked: false,
    value: ModelVulnerabilityScanConfigLanguageLanguageEnum.Rust,
  },
  {
    name: 'GoLang',
    checked: false,
    value: ModelVulnerabilityScanConfigLanguageLanguageEnum.Golang,
  },
  {
    name: 'Ruby',
    checked: false,
    value: ModelVulnerabilityScanConfigLanguageLanguageEnum.Ruby,
  },
  {
    name: 'Python',
    checked: false,
    value: ModelVulnerabilityScanConfigLanguageLanguageEnum.Python,
  },
  {
    name: 'PHP',
    checked: false,
    value: ModelVulnerabilityScanConfigLanguageLanguageEnum.Php,
  },
  {
    name: 'Dotnet',
    checked: false,
    value: ModelVulnerabilityScanConfigLanguageLanguageEnum.Dotnet,
  },
];

const SelectedAccountComponent = ({
  type,
  accounts,
}: {
  type: string;
  accounts: string[];
}) => {
  return (
    <span className={`${Typography.size.sm} text-gray-600 dark:text-gray-400`}>
      {accounts.length > 0 ? `${type} / ${accounts[0]}` : null}
      &nbsp;
      {accounts.length > 1 && (
        <Tooltip content={accounts.slice(1).join(', ')}>
          <span className={`${Typography.size.sm} text-blue-500 dark:text-blue-400`}>
            +{accounts.length - 1} more
          </span>
        </Tooltip>
      )}
    </span>
  );
};

const VulnerabilityScanConfigure = () => {
  const actionData = useActionData() as ScanActionReturnType;
  const { goBack } = usePageNavigation();
  const navigation = useNavigation();
  const fetcher = useFetcher();
  const [isSelectAll, setIsSelectAll] = useState(false);
  const [pkgs, setSelectPackages] = useState(packages);
  const [advanceOption, setAdvanceOption] = useState<{
    entireCluster: boolean;
    priorityScan: boolean;
  }>({
    entireCluster: false,
    priorityScan: false,
  });

  useEffect(() => {
    if (isSelectAll) {
      const newPkgs = pkgs.map((pkg) => {
        pkg.checked = true;
        return pkg;
      });
      setSelectPackages(newPkgs);
    }
  }, [isSelectAll]);

  const location = useLocation();
  const [pageState] = useState<unknown>(location.state);
  if (!Array.isArray(pageState) || !pageState.length) {
    return <Navigate to="/onboard/connectors/my-connectors" />;
  }
  const state = pageState as OnboardConnectionNode[];

  // select all switch
  const onSwitchChange = (checked: boolean) => {
    setIsSelectAll(checked);
    if (!checked) {
      const newPkgs = pkgs.map((pkg) => {
        pkg.checked = false;
        return pkg;
      });
      setSelectPackages(newPkgs);
    }
  };

  // packages checkbox
  const onPackageCheckedChange = (
    pkg: {
      name: string;
      checked: boolean;
    },
    checked: boolean,
  ) => {
    if (checked === false) {
      setIsSelectAll(false);
    } else if (pkgs.filter((pkg) => pkg.checked === true).length === pkgs.length - 1) {
      setIsSelectAll(true);
    }
    setSelectPackages((state) => {
      const _newState = cloneDeepWith(state, (value) => {
        if (value.name === pkg.name) {
          return {
            ...value,
            checked,
          };
        }
        return undefined;
      });

      return _newState;
    });
  };

  const isStatusPageLoading =
    navigation.location?.pathname.includes('/view-summary/running') &&
    navigation.state === 'loading';

  const onAdvancedOptionChange = (name: string, value: boolean) => {
    setAdvanceOption((state) => {
      return {
        ...state,
        [name]: value,
      };
    });
  };

  return (
    <fetcher.Form method="post">
      <input
        type="text"
        name="_nodeIds"
        hidden
        readOnly
        value={state.map((node) => node.urlId).join(',')}
      />
      <input type="text" name="_nodeType" readOnly hidden value={state[0].urlType} />
      <ConnectorHeader
        title="Configure Vulnerability Scan"
        description="Choose from the below options to perform your first scan."
        endComponent={
          <SelectedAccountComponent
            accounts={state.map((node) => node.urlId)}
            type={state[0].urlType}
          />
        }
      />

      {
        <section className="mb-4">
          <p className={`text-sm text-red-500`}>{actionData?.message}</p>
        </section>
      }

      <section>
        <div className="flex">
          <h6
            className={`${Typography.size.lg} ${Typography.weight.medium} mt-0 dark:text-white`}
          >
            Packages
          </h6>
          <Button
            disabled={fetcher.state === 'submitting' || isStatusPageLoading}
            loading={fetcher.state === 'submitting' || isStatusPageLoading}
            size="sm"
            color="primary"
            className="ml-auto"
            type="submit"
          >
            Start Scan
          </Button>
        </div>
        <div className="mt-4">
          <Switch
            label="Select All"
            size="sm"
            name="selectAll"
            value="all"
            onCheckedChange={onSwitchChange}
            checked={isSelectAll}
          />
        </div>

        <div className="flex flex-row mt-4 gap-5">
          {pkgs.map((pkg) => {
            return (
              <Checkbox
                label={pkg.name}
                key={pkg.name}
                name="packages"
                value={pkg.value}
                checked={isSelectAll ? true : pkg.checked}
                onCheckedChange={(checked: boolean) => {
                  onPackageCheckedChange(pkg, checked);
                }}
              />
            );
          })}
        </div>
      </section>

      {/* <section className="mt-8">
        <h6
          className={`${Typography.size.lg} ${Typography.weight.medium} mt-4 dark:text-white`}
        >
          Advanced Options
        </h6>

        <div className="flex flex-col mt-4 gap-4">
          <Checkbox
            label={
              'Scan Entire Cluster (All hosts and container images of all pods in the cluster)'
            }
            name="entireCluster"
            onCheckedChange={(checked: boolean) => {
              onAdvancedOptionChange('entireCluster', checked);
            }}
            checked={advanceOption.entireCluster}
          />
          <Checkbox
            label={'Priority Scan'}
            name="priorityScan"
            onCheckedChange={(checked: boolean) => {
              onAdvancedOptionChange('priorityScan', checked);
            }}
            checked={advanceOption.priorityScan}
          />
        </div>
      </section> */}
      <Button onClick={goBack} color="default" size="xs" className="mt-16">
        Go Back
      </Button>
    </fetcher.Form>
  );
};

export const module = {
  action,
  element: <VulnerabilityScanConfigure />,
};
