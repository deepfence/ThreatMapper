import { useSuspenseQuery } from '@suspensive/react-query';
import { capitalize } from 'lodash-es';
import { Suspense, useCallback, useEffect, useMemo, useState } from 'react';
import {
  ActionFunctionArgs,
  generatePath,
  Outlet,
  useFetcher,
  useParams,
  useSearchParams,
} from 'react-router-dom';
import { toast } from 'sonner';
import {
  Badge,
  Breadcrumb,
  BreadcrumbLink,
  Button,
  Card,
  CircleSpinner,
  Combobox,
  ComboboxOption,
  createColumnHelper,
  Dropdown,
  DropdownItem,
  DropdownSeparator,
  getRowSelectionColumn,
  IconButton,
  Modal,
  RowSelectionState,
  SortingState,
  Table,
  TableSkeleton,
} from 'ui-components';

import { getScanResultsApiClient } from '@/api/api';
import {
  ModelMalware,
  UtilsReportFiltersNodeTypeEnum,
  UtilsReportFiltersScanTypeEnum,
} from '@/api/generated';
import { DFLink } from '@/components/DFLink';
import { FilterBadge } from '@/components/filters/FilterBadge';
import { BellLineIcon } from '@/components/icons/common/BellLine';
import { CaretDown } from '@/components/icons/common/CaretDown';
import { ClockLineIcon } from '@/components/icons/common/ClockLine';
import { DownloadLineIcon } from '@/components/icons/common/DownloadLine';
import { EllipsisIcon } from '@/components/icons/common/Ellipsis';
import { ErrorStandardLineIcon } from '@/components/icons/common/ErrorStandardLine';
import { EyeHideSolid } from '@/components/icons/common/EyeHideSolid';
import { EyeSolidIcon } from '@/components/icons/common/EyeSolid';
import { FilterIcon } from '@/components/icons/common/Filter';
import { TimesIcon } from '@/components/icons/common/Times';
import { TrashLineIcon } from '@/components/icons/common/TrashLine';
import { ScanHistoryDropdown } from '@/components/scan-history/HistoryList';
import { ScanStatusBadge } from '@/components/ScanStatusBadge';
import { ScanStatusInError, ScanStatusInProgress } from '@/components/ScanStatusMessage';
import { SeverityBadge } from '@/components/SeverityBadge';
import { MalwareIcon } from '@/components/sideNavigation/icons/Malware';
import { TruncatedText } from '@/components/TruncatedText';
import { SEVERITY_COLORS } from '@/constants/charts';
import { useDownloadScan } from '@/features/common/data-component/downloadScanAction';
import { MalwareScanResultsPieChart } from '@/features/malwares/components/scan-results/MalwareScanResultsPieChart';
import { SuccessModalContent } from '@/features/settings/components/SuccessModalContent';
import { invalidateAllQueries, queries } from '@/queries';
import { MalwareSeverityType, ScanStatusEnum, ScanTypeEnum } from '@/types/common';
import { apiWrapper } from '@/utils/api';
import { formatMilliseconds } from '@/utils/date';
import { abbreviateNumber } from '@/utils/number';
import {
  getOrderFromSearchParams,
  getPageFromSearchParams,
  useSortingState,
} from '@/utils/table';
import { usePageNavigation } from '@/utils/usePageNavigation';

enum ActionEnumType {
  MASK = 'mask',
  UNMASK = 'unmask',
  DELETE = 'delete',
  NOTIFY = 'notify',
  DELETE_SCAN = 'delete_scan',
}

const DEFAULT_PAGE_SIZE = 10;

type ActionFunctionType =
  | ReturnType<typeof getScanResultsApiClient>['deleteScanResult']
  | ReturnType<typeof getScanResultsApiClient>['maskScanResult']
  | ReturnType<typeof getScanResultsApiClient>['notifyScanResult']
  | ReturnType<typeof getScanResultsApiClient>['unmaskScanResult'];

type ActionData = {
  action: ActionEnumType;
  success: boolean;
  message?: string;
} | null;

const action = async ({
  params: { scanId = '' },
  request,
}: ActionFunctionArgs): Promise<ActionData> => {
  const formData = await request.formData();
  const ids = (formData.getAll('nodeIds[]') ?? []) as string[];
  const actionType = formData.get('actionType');
  const _scanId = scanId;
  const mask = formData.get('maskHostAndImages');
  if (!_scanId) {
    throw new Error('Scan ID is required');
  }
  if (!actionType) {
    return null;
  }

  let result = null;
  let apiFunction: ActionFunctionType | null = null;
  if (actionType === ActionEnumType.DELETE || actionType === ActionEnumType.NOTIFY) {
    apiFunction =
      actionType === ActionEnumType.DELETE
        ? getScanResultsApiClient().deleteScanResult
        : getScanResultsApiClient().notifyScanResult;
    const apiFunctionApi = apiWrapper({
      fn: apiFunction,
    });
    result = await apiFunctionApi({
      modelScanResultsActionRequest: {
        result_ids: [...ids],
        scan_id: _scanId,
        scan_type: ScanTypeEnum.MalwareScan,
      },
    });
    if (!result.ok) {
      if (result.error.response.status === 400 || result.error.response.status === 409) {
        return {
          action: actionType,
          success: false,
          message: result.error.message ?? '',
        };
      } else if (result.error.response.status === 403) {
        if (actionType === ActionEnumType.DELETE) {
          return {
            action: actionType,
            success: false,
            message: 'You do not have enough permissions to delete malware',
          };
        } else if (actionType === ActionEnumType.NOTIFY) {
          return {
            action: actionType,
            success: false,
            message: 'You do not have enough permissions to notify',
          };
        }
      }
    }
  } else if (actionType === ActionEnumType.MASK || actionType === ActionEnumType.UNMASK) {
    apiFunction =
      actionType === ActionEnumType.MASK
        ? getScanResultsApiClient().maskScanResult
        : getScanResultsApiClient().unmaskScanResult;
    const apiFunctionApi = apiWrapper({
      fn: apiFunction,
    });
    result = await apiFunctionApi({
      modelScanResultsMaskRequest: {
        mask_across_hosts_and_images: mask === 'maskHostAndImages',
        result_ids: [...ids],
        scan_id: _scanId,
        scan_type: ScanTypeEnum.MalwareScan,
      },
    });
    if (!result.ok) {
      if (result.error.response.status === 400 || result.error.response.status === 409) {
        return {
          action: actionType,
          success: false,
          message: result.error.message ?? '',
        };
      } else if (result.error.response.status === 403) {
        if (actionType === ActionEnumType.MASK) {
          toast.error('You do not have enough permissions to mask');
          return {
            action: actionType,
            success: false,
            message: 'You do not have enough permissions to mask',
          };
        } else if (actionType === ActionEnumType.UNMASK) {
          toast.error('You do not have enough permissions to unmask');
          return {
            action: actionType,
            success: false,
            message: 'You do not have enough permissions to unmask',
          };
        }
      }
    }
  } else if (actionType === ActionEnumType.DELETE_SCAN) {
    const deleteScan = apiWrapper({
      fn: getScanResultsApiClient().deleteScanResultsForScanID,
    });

    const result = await deleteScan({
      scanId: formData.get('scanId') as string,
      scanType: ScanTypeEnum.MalwareScan,
    });

    if (!result.ok) {
      if (result.error.response.status === 403) {
        return {
          action: actionType,
          success: false,
          message: 'You do not have enough permissions to delete scan',
        };
      }
      throw new Error('Error deleting scan');
    }
  }

  invalidateAllQueries();

  if (actionType === ActionEnumType.DELETE || actionType === ActionEnumType.DELETE_SCAN) {
    return {
      action: actionType,
      success: true,
    };
  } else if (actionType === ActionEnumType.NOTIFY) {
    toast.success('Notified successfully');
  } else if (actionType === ActionEnumType.MASK) {
    toast.success('Masked successfully');
  } else if (actionType === ActionEnumType.UNMASK) {
    toast.success('Unmasked successfully');
  }
  return null;
};
const FILTER_SEARCHPARAMS: Record<string, string> = {
  visibility: 'Masked/Unmasked',
  severity: 'Severity',
};
const getAppliedFiltersCount = (searchParams: URLSearchParams) => {
  return Object.keys(FILTER_SEARCHPARAMS).reduce((prev, curr) => {
    return prev + searchParams.getAll(curr).length;
  }, 0);
};
const useScanResults = () => {
  const [searchParams] = useSearchParams();
  const params = useParams();
  const scanId = params?.scanId ?? '';
  return useSuspenseQuery({
    ...queries.malware.scanResults({
      scanId,
      page: getPageFromSearchParams(searchParams),
      pageSize: parseInt(searchParams.get('size') ?? String(DEFAULT_PAGE_SIZE)),
      order: getOrderFromSearchParams(searchParams) || {
        sortBy: 'file_severity',
        descending: true,
      },
      rules: searchParams.getAll('rules'),
      severity: searchParams.getAll('severity'),
      classes: searchParams.getAll('classes'),
      visibility: searchParams.getAll('visibility'),
    }),
    keepPreviousData: true,
  });
};

const useTop5Malwares = () => {
  const params = useParams();
  const scanId = params?.scanId ?? '';
  return useSuspenseQuery({
    ...queries.malware.top5MalwaresForScan({
      scanId,
    }),
  });
};

const DeleteConfirmationModal = ({
  showDialog,
  ids,
  setShowDialog,
  onDeleteSuccess,
}: {
  showDialog: boolean;
  ids: string[];
  setShowDialog: React.Dispatch<React.SetStateAction<boolean>>;
  onDeleteSuccess: () => void;
}) => {
  const fetcher = useFetcher<ActionData>();

  const onDeleteAction = useCallback(
    (actionType: string) => {
      const formData = new FormData();
      formData.append('actionType', actionType);
      ids.forEach((item) => formData.append('nodeIds[]', item));
      fetcher.submit(formData, {
        method: 'post',
      });
    },
    [ids, fetcher],
  );

  useEffect(() => {
    if (
      fetcher.state === 'idle' &&
      fetcher.data?.success &&
      fetcher.data.action === ActionEnumType.DELETE
    ) {
      onDeleteSuccess();
    }
  }, [fetcher]);

  return (
    <Modal
      size="s"
      open={showDialog}
      onOpenChange={() => setShowDialog(false)}
      title={
        !fetcher.data?.success ? (
          <div className="flex gap-3 items-center dark:text-status-error">
            <span className="h-6 w-6 shrink-0">
              <ErrorStandardLineIcon />
            </span>
            Delete {ids.length > 1 ? 'malwares' : 'malware'}
          </div>
        ) : undefined
      }
      footer={
        !fetcher.data?.success ? (
          <div className={'flex gap-x-4 justify-end'}>
            <Button
              size="sm"
              onClick={() => setShowDialog(false)}
              type="button"
              variant="outline"
            >
              Cancel
            </Button>
            <Button
              size="sm"
              color="error"
              onClick={(e) => {
                e.preventDefault();
                onDeleteAction(ActionEnumType.DELETE);
              }}
            >
              Yes, I&apos;m sure
            </Button>
          </div>
        ) : undefined
      }
    >
      {!fetcher.data?.success ? (
        <div className="grid">
          <span>The selected malwares will be deleted.</span>
          <br />
          <span>Are you sure you want to delete?</span>
          {fetcher.data?.message && <p className="">{fetcher.data?.message}</p>}
          <div className="flex items-center justify-right gap-4"></div>
        </div>
      ) : (
        <SuccessModalContent text="Deleted successfully!" />
      )}
    </Modal>
  );
};

const DeleteScanConfirmationModal = ({
  open,
  onOpenChange,
  scanId,
}: {
  scanId: string;
  open: boolean;
  onOpenChange: (open: boolean) => void;
}) => {
  const fetcher = useFetcher<ActionData>();
  const onDeleteScan = () => {
    const formData = new FormData();
    formData.append('actionType', ActionEnumType.DELETE_SCAN);
    formData.append('scanId', scanId);
    fetcher.submit(formData, {
      method: 'post',
    });
  };
  return (
    <Modal
      open={open}
      onOpenChange={onOpenChange}
      size="s"
      title={
        !fetcher.data?.success ? (
          <div className="flex gap-3 items-center dark:text-status-error">
            <span className="h-6 w-6 shrink-0">
              <ErrorStandardLineIcon />
            </span>
            Delete scan
          </div>
        ) : undefined
      }
      footer={
        !fetcher.data?.success ? (
          <div className={'flex gap-x-4 justify-end'}>
            <Button
              size="sm"
              onClick={() => onOpenChange(false)}
              type="button"
              variant="outline"
            >
              Cancel
            </Button>
            <Button
              size="sm"
              color="error"
              onClick={(e) => {
                e.preventDefault();
                onDeleteScan();
              }}
            >
              Yes, I&apos;m sure
            </Button>
          </div>
        ) : undefined
      }
    >
      {!fetcher.data?.success ? (
        <div className="grid">
          <span>
            Are you sure you want to delete this scan? This action cannot be undone.
          </span>
          {fetcher.data?.message && <p className="">{fetcher.data?.message}</p>}
          <div className="flex items-center justify-right gap-4"></div>
        </div>
      ) : (
        <SuccessModalContent text="Scan deleted successfully!" />
      )}
    </Modal>
  );
};

const ScanHistory = () => {
  return (
    <div className="mx-4 mt-1.5 min-h-[36px] flex items-center">
      <span className="h-3.5 w-3.5 dark:text-text-input-value">
        <ClockLineIcon />
      </span>
      <span className="pl-2 pr-3 text-t3 dark:text-text-text-and-icon uppercase">
        scan time
      </span>
      <Suspense
        fallback={
          <div className="dark:text-text-text-and-icon text-p9">
            Fetching scan history...
          </div>
        }
      >
        <HistoryControls />
      </Suspense>
      <Button className="ml-auto" size="md">
        Start scan
      </Button>
    </div>
  );
};

const HistoryControls = () => {
  const { data } = useScanResults();
  const { scanStatusResult } = data;
  const { scan_id, node_id, node_type, updated_at, status } = scanStatusResult ?? {};
  const { navigate } = usePageNavigation();
  const { downloadScan } = useDownloadScan();

  const [scanIdToDelete, setScanIdToDelete] = useState<string | null>(null);

  const { data: historyData } = useSuspenseQuery({
    ...queries.malware.scanHistories({
      nodeId: node_id ?? '',
      nodeType: node_type ?? '',
    }),
  });

  if (!scan_id || !node_id || !node_type) {
    throw new Error('Scan Type, Node Type and Node Id are required');
  }
  if (!updated_at) {
    return null;
  }
  return (
    <div className="flex items-center gap-x-3">
      <ScanHistoryDropdown
        scans={[...(historyData?.data ?? [])].reverse().map((item) => ({
          id: item.scanId,
          isCurrent: item.scanId === scan_id,
          status: item.status,
          timestamp: formatMilliseconds(item.updatedAt),
          onDeleteClick: (id) => {
            setScanIdToDelete(id);
          },
          onDownloadClick: () => {
            downloadScan({
              scanId: item.scanId,
              scanType: UtilsReportFiltersScanTypeEnum.Malware,
              nodeType: node_type as UtilsReportFiltersNodeTypeEnum,
            });
          },
          onScanClick: () => {
            navigate(
              generatePath('/malware/scan-results/:scanId', {
                scanId: item.scanId,
              }),
              {
                replace: true,
              },
            );
          },
        }))}
        currentTimeStamp={formatMilliseconds(updated_at)}
      />

      {scanIdToDelete && (
        <DeleteScanConfirmationModal
          scanId={scanIdToDelete}
          open={!!scanIdToDelete}
          onOpenChange={(open) => {
            if (!open) setScanIdToDelete(null);
          }}
        />
      )}
      <div className="h-3 w-[1px] dark:bg-bg-grid-border"></div>
      <ScanStatusBadge status={status ?? ''} />
      <div className="h-3 w-[1px] dark:bg-bg-grid-border"></div>
      <div className="pl-1.5 flex">
        <IconButton
          variant="flat"
          icon={
            <span className="h-3 w-3">
              <DownloadLineIcon />
            </span>
          }
          size="md"
          onClick={() => {
            downloadScan({
              scanId: scan_id,
              scanType: UtilsReportFiltersScanTypeEnum.Malware,
              nodeType: node_type as UtilsReportFiltersNodeTypeEnum,
            });
          }}
        />
        <IconButton
          variant="flat"
          icon={
            <span className="h-3 w-3">
              <TrashLineIcon />
            </span>
          }
          onClick={() => setScanIdToDelete(scan_id)}
        />
      </div>
    </div>
  );
};

const ActionDropdown = ({
  ids,
  trigger,
  setIdsToDelete,
  setShowDeleteDialog,
  onTableAction,
}: {
  ids: string[];
  trigger: React.ReactNode;
  setIdsToDelete: React.Dispatch<React.SetStateAction<string[]>>;
  setShowDeleteDialog: React.Dispatch<React.SetStateAction<boolean>>;
  onTableAction: (ids: string[], actionType: string, maskHostAndImages?: string) => void;
}) => {
  return (
    <Dropdown
      triggerAsChild={true}
      align={'start'}
      content={
        <>
          <DropdownItem onClick={() => onTableAction(ids, ActionEnumType.MASK, '')}>
            Mask malware
          </DropdownItem>
          <DropdownItem
            onClick={() => onTableAction(ids, ActionEnumType.MASK, 'maskHostAndImages')}
          >
            Mask malware across hosts and images
          </DropdownItem>
          <DropdownSeparator />
          <DropdownItem onClick={() => onTableAction(ids, ActionEnumType.UNMASK, '')}>
            Un-mask malware
          </DropdownItem>
          <DropdownItem
            onClick={() => onTableAction(ids, ActionEnumType.UNMASK, 'maskHostAndImages')}
          >
            Un-mask malware across hosts and images
          </DropdownItem>
          <DropdownSeparator />
          <DropdownItem onClick={() => onTableAction(ids, ActionEnumType.NOTIFY)}>
            Notify
          </DropdownItem>
          <DropdownSeparator />
          <DropdownItem
            onClick={() => {
              setIdsToDelete(ids);
              setShowDeleteDialog(true);
            }}
          >
            Delete
          </DropdownItem>
        </>
      }
    >
      {trigger}
    </Dropdown>
  );
};

const BulkActions = ({
  ids,
  setIdsToDelete,
  setShowDeleteDialog,
  onTableAction,
}: {
  ids: string[];
  setIdsToDelete: React.Dispatch<React.SetStateAction<string[]>>;
  setShowDeleteDialog: React.Dispatch<React.SetStateAction<boolean>>;
  onTableAction: (ids: string[], actionType: string, maskHostAndImages?: string) => void;
}) => {
  return (
    <>
      <Dropdown
        triggerAsChild
        align={'start'}
        disabled={!ids.length}
        content={
          <>
            <DropdownItem onClick={() => onTableAction(ids, ActionEnumType.MASK, '')}>
              Mask malwares
            </DropdownItem>
            <DropdownItem
              onClick={() => onTableAction(ids, ActionEnumType.MASK, 'maskHostAndImages')}
            >
              Mask malwares across hosts and images
            </DropdownItem>
          </>
        }
      >
        <Button
          color="default"
          variant="flat"
          size="sm"
          startIcon={<EyeSolidIcon />}
          endIcon={<CaretDown />}
          disabled={!ids.length}
        >
          Mask
        </Button>
      </Dropdown>
      <Dropdown
        triggerAsChild
        align={'start'}
        disabled={!ids.length}
        content={
          <>
            <DropdownItem onClick={() => onTableAction(ids, ActionEnumType.UNMASK, '')}>
              Un-mask malwares
            </DropdownItem>
            <DropdownItem
              onClick={() =>
                onTableAction(ids, ActionEnumType.UNMASK, 'maskHostAndImages')
              }
            >
              Un-mask malwares across hosts and images
            </DropdownItem>
          </>
        }
      >
        <Button
          color="default"
          variant="flat"
          size="sm"
          startIcon={<EyeHideSolid />}
          endIcon={<CaretDown />}
          disabled={!ids.length}
        >
          Unmask
        </Button>
      </Dropdown>
      <Button
        color="default"
        variant="flat"
        size="sm"
        startIcon={<BellLineIcon />}
        disabled={!ids.length}
        onClick={() => {
          onTableAction(ids, ActionEnumType.NOTIFY);
        }}
      >
        Notify
      </Button>
      <Button
        color="error"
        variant="flat"
        size="sm"
        startIcon={<TrashLineIcon />}
        disabled={!ids.length}
        onClick={() => {
          setIdsToDelete(ids);
          setShowDeleteDialog(true);
        }}
      >
        Delete
      </Button>
    </>
  );
};

const Filters = () => {
  const [searchParams, setSearchParams] = useSearchParams();
  const [maskedQuery, setMaskedQuery] = useState('');
  const [severityQuery, setSeverityQuery] = useState('');
  const appliedFilterCount = getAppliedFiltersCount(searchParams);

  return (
    <div className="px-4 py-2.5 mb-4 border dark:border-bg-hover-3 rounded-[5px] overflow-hidden dark:bg-bg-left-nav">
      <div className="flex gap-2">
        <Combobox
          getDisplayValue={() => FILTER_SEARCHPARAMS['visibility']}
          multiple
          value={searchParams.getAll('visibility')}
          onChange={(values) => {
            setSearchParams((prev) => {
              prev.delete('visibility');
              values.forEach((value) => {
                prev.append('visibility', value);
              });
              prev.delete('page');
              return prev;
            });
          }}
          onQueryChange={(query) => {
            setMaskedQuery(query);
          }}
          clearAllElement="Clear"
          onClearAll={() => {
            setSearchParams((prev) => {
              prev.delete('visibility');
              prev.delete('page');
              return prev;
            });
          }}
        >
          {['masked', 'unmasked']
            .filter((item) => {
              if (!maskedQuery.length) return true;
              return item.includes(maskedQuery.toLowerCase());
            })
            .map((item) => {
              return (
                <ComboboxOption key={item} value={item}>
                  {capitalize(item)}
                </ComboboxOption>
              );
            })}
        </Combobox>
        <Combobox
          getDisplayValue={() => FILTER_SEARCHPARAMS['severity']}
          multiple
          value={searchParams.getAll('severity')}
          onChange={(values) => {
            setSearchParams((prev) => {
              prev.delete('severity');
              values.forEach((value) => {
                prev.append('severity', value);
              });
              prev.delete('page');
              return prev;
            });
          }}
          onQueryChange={(query) => {
            setSeverityQuery(query);
          }}
          clearAllElement="Clear"
          onClearAll={() => {
            setSearchParams((prev) => {
              prev.delete('severity');
              prev.delete('page');
              return prev;
            });
          }}
        >
          {['critical', 'high', 'medium', 'low', 'unknown']
            .filter((item) => {
              if (!severityQuery.length) return true;
              return item.includes(severityQuery.toLowerCase());
            })
            .map((item) => {
              return (
                <ComboboxOption key={item} value={item}>
                  {capitalize(item)}
                </ComboboxOption>
              );
            })}
        </Combobox>
      </div>
      {appliedFilterCount > 0 ? (
        <div className="flex gap-2.5 mt-4 flex-wrap items-center">
          {Array.from(searchParams)
            .filter(([key]) => {
              return Object.keys(FILTER_SEARCHPARAMS).includes(key);
            })
            .map(([key, value]) => {
              return (
                <FilterBadge
                  key={`${key}-${value}`}
                  onRemove={() => {
                    setSearchParams((prev) => {
                      const existingValues = prev.getAll(key);
                      prev.delete(key);
                      existingValues.forEach((existingValue) => {
                        if (existingValue !== value) prev.append(key, existingValue);
                      });
                      prev.delete('page');
                      return prev;
                    });
                  }}
                  text={`${FILTER_SEARCHPARAMS[key]}: ${value}`}
                />
              );
            })}
          <Button
            variant="flat"
            color="default"
            startIcon={<TimesIcon />}
            onClick={() => {
              setSearchParams((prev) => {
                Object.keys(FILTER_SEARCHPARAMS).forEach((key) => {
                  prev.delete(key);
                });
                prev.delete('page');
                return prev;
              });
            }}
            size="sm"
          >
            Clear all
          </Button>
        </div>
      ) : null}
    </div>
  );
};

const MalwareTable = ({
  onTableAction,
  setIdsToDelete,
  setShowDeleteDialog,
  rowSelectionState,
  setRowSelectionState,
}: {
  onTableAction: (ids: string[], actionType: string, maskHostAndImages?: string) => void;
  setIdsToDelete: React.Dispatch<React.SetStateAction<string[]>>;
  setShowDeleteDialog: React.Dispatch<React.SetStateAction<boolean>>;
  rowSelectionState: RowSelectionState;
  setRowSelectionState: React.Dispatch<React.SetStateAction<RowSelectionState>>;
}) => {
  const [searchParams, setSearchParams] = useSearchParams();
  const { data } = useScanResults();
  const columnHelper = createColumnHelper<ModelMalware>();
  const [sort, setSort] = useSortingState();
  const columns = useMemo(() => {
    const columns = [
      getRowSelectionColumn(columnHelper, {
        size: 40,
        minSize: 40,
        maxSize: 40,
      }),
      columnHelper.display({
        id: 'actions',
        enableSorting: false,
        cell: (cell) => (
          <ActionDropdown
            ids={[cell.row.original.node_id]}
            setIdsToDelete={setIdsToDelete}
            setShowDeleteDialog={setShowDeleteDialog}
            onTableAction={onTableAction}
            trigger={
              <button className="p-1">
                <div className="h-[16px] w-[16px] dark:text-text-text-and-icon rotate-90">
                  <EllipsisIcon />
                </div>
              </button>
            }
          />
        ),
        header: () => '',
        size: 40,
        minSize: 40,
        maxSize: 50,
        enableResizing: false,
      }),
      columnHelper.accessor('node_id', {
        cell: (info) => (
          <DFLink
            to={{
              pathname: `./${encodeURIComponent(info.getValue())}`,
              search: searchParams.toString(),
            }}
            className="flex items-center gap-x-[6px]"
          >
            <div className="h-6 w-6 flex items-center justify-center bg-gray-100 shrink-0 dark:bg-[rgba(224,_81,_109,_0.2)] rounded-[5px]">
              <div className="w-3 h-3 dark:text-status-error">
                <MalwareIcon />
              </div>
            </div>
            <div className="truncate">{info.getValue()}</div>
          </DFLink>
        ),
        header: () => 'ID',
        minSize: 100,
        size: 120,
        maxSize: 130,
      }),
      columnHelper.accessor('rule_name', {
        cell: (info) => <TruncatedText text={info.getValue() ?? ''} />,
        header: () => <TruncatedText text="Rule name" />,
        minSize: 100,
        size: 120,
        maxSize: 130,
      }),
      columnHelper.accessor('complete_filename', {
        cell: (info) => <TruncatedText text={info.getValue()} />,
        header: () => <TruncatedText text="File name" />,
        minSize: 180,
        size: 180,
        maxSize: 190,
      }),
      columnHelper.accessor('file_severity', {
        enableResizing: true,
        cell: (info) => <SeverityBadge severity={info.getValue()} />,
        header: () => <TruncatedText text="Severity" />,
        minSize: 80,
        size: 90,
        maxSize: 100,
      }),
      columnHelper.accessor('strings_to_match', {
        enableResizing: true,
        enableSorting: false,
        cell: (info) => <TruncatedText text={info.getValue()?.join(', ') ?? ''} />,
        header: () => <TruncatedText text="Strings to match" />,
        minSize: 150,
        size: 160,
        maxSize: 165,
      }),
      columnHelper.accessor('resources', {
        enableSorting: false,
        enableResizing: true,
        cell: (info) => {
          return <TruncatedText text={info.getValue()?.join(', ') ?? ''} />;
        },
        header: () => <TruncatedText text="Affected Resources" />,
        minSize: 180,
        size: 180,
        maxSize: 190,
      }),
      columnHelper.accessor('summary', {
        enableSorting: false,
        enableResizing: true,
        cell: (info) => <TruncatedText text={info.getValue() ?? ''} />,
        header: () => <TruncatedText text="Description" />,
        minSize: 200,
        size: 200,
        maxSize: 210,
      }),
    ];

    return columns;
  }, [setSearchParams]);

  const { data: scanResultData, scanStatusResult } = data;

  if (scanStatusResult?.status === ScanStatusEnum.error) {
    return <ScanStatusInError errorMessage={scanStatusResult.status_message} />;
  } else if (
    scanStatusResult?.status !== ScanStatusEnum.error &&
    scanStatusResult?.status !== ScanStatusEnum.complete
  ) {
    return <ScanStatusInProgress LogoIcon={MalwareIcon} />;
  }
  if (!scanResultData) {
    return null;
  }

  return (
    <Table
      size="default"
      data={scanResultData.tableData}
      columns={columns}
      enableRowSelection
      rowSelectionState={rowSelectionState}
      onRowSelectionChange={setRowSelectionState}
      enablePagination
      manualPagination
      enableColumnResizing
      approximatePagination
      totalRows={scanResultData.pagination.totalRows}
      pageSize={parseInt(searchParams.get('size') ?? String(DEFAULT_PAGE_SIZE))}
      pageIndex={scanResultData.pagination.currentPage}
      getRowId={(row) => `${row.node_id}`}
      enableSorting
      manualSorting
      sortingState={sort}
      onSortingChange={(updaterOrValue) => {
        let newSortState: SortingState = [];
        if (typeof updaterOrValue === 'function') {
          newSortState = updaterOrValue(sort);
        } else {
          newSortState = updaterOrValue;
        }
        setSearchParams((prev) => {
          if (!newSortState.length) {
            prev.delete('sortby');
            prev.delete('desc');
          } else {
            prev.set('sortby', String(newSortState[0].id));
            prev.set('desc', String(newSortState[0].desc));
          }
          return prev;
        });
        setSort(newSortState);
      }}
      onPaginationChange={(updaterOrValue) => {
        let newPageIndex = 0;
        if (typeof updaterOrValue === 'function') {
          newPageIndex = updaterOrValue({
            pageIndex: scanResultData.pagination.currentPage,
            pageSize: parseInt(searchParams.get('size') ?? String(DEFAULT_PAGE_SIZE)),
          }).pageIndex;
        } else {
          newPageIndex = updaterOrValue.pageIndex;
        }
        setSearchParams((prev) => {
          prev.set('page', String(newPageIndex));
          return prev;
        });
      }}
      getTrProps={(row) => {
        if (row.original.masked) {
          return {
            className: 'opacity-40',
          };
        }
        return {};
      }}
      enablePageResize
      onPageResize={(newSize) => {
        setSearchParams((prev) => {
          prev.set('size', String(newSize));
          prev.delete('page');
          return prev;
        });
      }}
    />
  );
};

const Header = () => {
  return (
    <div className="flex pl-6 pr-4 py-2 w-full items-center bg-white dark:bg-bg-breadcrumb-bar">
      <>
        <Breadcrumb>
          <BreadcrumbLink asChild icon={<MalwareIcon />} isLink>
            <DFLink to={'/malware'} unstyled>
              Malwares
            </DFLink>
          </BreadcrumbLink>
          <Suspense
            fallback={
              <BreadcrumbLink isLast>
                <CircleSpinner size="sm" />
              </BreadcrumbLink>
            }
          >
            <DynamicBreadcrumbs />
          </Suspense>
        </Breadcrumb>
      </>
    </div>
  );
};
const DynamicBreadcrumbs = () => {
  const { data } = useScanResults();
  const { scanStatusResult } = data;

  const { node_type, node_name } = scanStatusResult ?? {};

  return (
    <>
      <BreadcrumbLink isLink icon={<MalwareIcon />} asChild>
        <DFLink to={`/malware/scans?nodeType=${node_type}`} unstyled>
          {capitalize(node_type ?? '')}
        </DFLink>
      </BreadcrumbLink>
      <BreadcrumbLink icon={<MalwareIcon />} isLast>
        <span className="inherit cursor-auto">{node_name}</span>
      </BreadcrumbLink>
    </>
  );
};
const ScanResults = () => {
  const [searchParams] = useSearchParams();
  const [rowSelectionState, setRowSelectionState] = useState<RowSelectionState>({});
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  const [idsToDelete, setIdsToDelete] = useState<string[]>([]);
  const [filtersExpanded, setFiltersExpanded] = useState(false);
  const fetcher = useFetcher<ActionData>();

  const onTableAction = useCallback(
    (ids: string[], actionType: string, maskHostAndImages?: string) => {
      const formData = new FormData();
      formData.append('actionType', actionType);

      if (actionType === ActionEnumType.MASK || actionType === ActionEnumType.UNMASK) {
        formData.append('maskHostAndImages', maskHostAndImages ?? '');
      }

      ids.forEach((item) => formData.append('nodeIds[]', item));
      fetcher.submit(formData, {
        method: 'post',
      });
    },
    [fetcher],
  );

  const selectedIds = useMemo(() => {
    return Object.keys(rowSelectionState);
  }, [rowSelectionState]);

  return (
    <div className="self-start">
      <div className="py-2 flex items-center">
        <BulkActions
          ids={selectedIds}
          onTableAction={onTableAction}
          setIdsToDelete={setIdsToDelete}
          setShowDeleteDialog={setShowDeleteDialog}
        />
        <div className="pr-2 ml-auto flex items-center gap-1">
          <Button
            className="pr-0"
            color="default"
            variant="flat"
            size="sm"
            startIcon={<FilterIcon />}
            onClick={() => {
              setFiltersExpanded((prev) => !prev);
            }}
          >
            Filter
          </Button>
          {getAppliedFiltersCount(searchParams) > 0 ? (
            <Badge
              label={String(getAppliedFiltersCount(searchParams))}
              variant="filled"
              size="small"
              color="blue"
            />
          ) : null}
        </div>
      </div>
      {filtersExpanded ? <Filters /> : null}
      <Suspense fallback={<TableSkeleton columns={7} rows={10} />}>
        <MalwareTable
          onTableAction={onTableAction}
          setShowDeleteDialog={setShowDeleteDialog}
          setIdsToDelete={setIdsToDelete}
          rowSelectionState={rowSelectionState}
          setRowSelectionState={setRowSelectionState}
        />
      </Suspense>
      {showDeleteDialog && (
        <DeleteConfirmationModal
          showDialog={showDeleteDialog}
          ids={idsToDelete}
          setShowDialog={setShowDeleteDialog}
          onDeleteSuccess={() => {
            setRowSelectionState({});
          }}
        />
      )}
    </div>
  );
};
const SeverityCountWidget = () => {
  const {
    data: { data },
  } = useScanResults();
  const severityCounts: {
    [k: string]: number;
  } = data?.severityCounts ?? {};
  return (
    <div className="flex items-center">
      <div className="h-[140px] w-[140px]">
        <MalwareScanResultsPieChart data={severityCounts} />
      </div>
      <div className="flex flex-1 justify-center">
        <div className="flex flex-col flex-1 max-w-[160px] gap-1">
          {Object.keys(severityCounts)?.map((key) => {
            return (
              <div className="flex gap-2 w-full py-[3px] items-center" key={key}>
                <div
                  className="h-3 w-3 rounded-full"
                  style={{
                    backgroundColor:
                      SEVERITY_COLORS[key.toLowerCase() as MalwareSeverityType],
                  }}
                ></div>
                <div className="capitalize text-p7 dark:text-text-text-and-icon">
                  {key}
                </div>
                <div className="ml-auto text-p7 dark:text-text-input-value">
                  {abbreviateNumber(severityCounts?.[key] ?? 0)}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
};
const Top5Widget = () => {
  const { data } = useTop5Malwares();
  const [searchParams] = useSearchParams();

  return (
    <table className="table-fixed w-full">
      <tbody>
        {data.data?.map((malware) => {
          return (
            <tr key={malware.node_id}>
              <td className="w-[70%] px-0 pt-0 pb-2">
                <DFLink
                  to={{
                    pathname: `./${encodeURIComponent(malware.node_id)}`,
                    search: searchParams.toString(),
                  }}
                  className="flex items-center gap-3"
                >
                  <div className="w-[14px] h-[14px] shrink-0">
                    <MalwareIcon />
                  </div>
                  <div className="text-p7 truncate">
                    <TruncatedText text={malware.node_id} />
                  </div>
                </DFLink>
              </td>
              <td className="w-[30%] px-0 pt-0 pb-2">
                <div className="flex items-center justify-end">
                  <SeverityBadge severity={malware.file_severity} />
                </div>
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  );
};

const Widgets = () => {
  return (
    <div className="grid grid-cols-3 gap-4 flex-nowrap min-h-[200px]">
      <Card className="flex-1 px-4 py-1.5 flex flex-col">
        <div className="text-h6 dark:text-text-input-value py-1">Total malwares</div>
        <div className="mt-2 flex-1 pl-4">
          <Suspense
            fallback={
              <div className="flex items-center justify-center min-h-[100px]">
                <CircleSpinner size="md" />
              </div>
            }
          >
            <SeverityCountWidget />
          </Suspense>
        </div>
      </Card>
      <Card className="flex-1 px-4 py-1.5 flex flex-col">
        <div className="text-h6 dark:text-text-input-value py-1">Top 5 malwares</div>
        <div className="mt-2 flex-1">
          <Suspense
            fallback={
              <div className="flex items-center justify-center min-h-[100px]">
                <CircleSpinner size="md" />
              </div>
            }
          >
            <Top5Widget />
          </Suspense>
        </div>
      </Card>
      <Card className="flex-1 px-4 py-1.5 flex flex-col">
        <div className="text-h6 dark:text-text-input-value py-1">Top attack paths</div>
        <div className="flex-1 flex gap-2 items-center justify-center p-6 dark:text-text-text-and-icon">
          <div className="h-6 w-6 shrink-0">
            <ErrorStandardLineIcon />
          </div>
          <div className="text-h3">Coming soon.</div>
        </div>
      </Card>
    </div>
  );
};
const MalwareScanResults = () => {
  return (
    <>
      <Header />
      <ScanHistory />
      <div className="px-4 pb-4 pt-1.5">
        <Widgets />
      </div>

      <div className="px-4 pb-4">
        <ScanResults />
      </div>
      <Outlet />
    </>
  );
};

export const module = {
  action,
  element: <MalwareScanResults />,
};
