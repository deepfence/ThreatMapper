import cx from 'classnames';
import { Suspense, useState } from 'react';
import { FaExpandAlt } from 'react-icons/fa';
import { HiChevronDown, HiExternalLink } from 'react-icons/hi';
import { IconContext } from 'react-icons/lib';
import { MdCopyAll } from 'react-icons/md';
import { Await, Form, LoaderFunctionArgs, useLoaderData } from 'react-router-dom';
import { Badge, CircleSpinner, ModalHeader, SlidingModal } from 'ui-components';

import { getSearchApiClient } from '@/api/api';
import { ApiDocsBadRequestResponse } from '@/api/generated';
import { CopyToClipboardAsJson } from '@/components/CopyToClipboardIcon';
import { DFLink } from '@/components/DFLink';
import { VulnerabilityIcon } from '@/components/sideNavigation/icons/Vulnerability';
import { DagreGraphAttackPath } from '@/features/vulnerabilities/components/unique-vulnerabilities/DagreGraphAttackPath';
import { ApiError, makeRequest } from '@/utils/api';
import { typedDefer, TypedDeferredData } from '@/utils/router';
import { usePageNavigation } from '@/utils/usePageNavigation';

type CveType = {
  cveId: string;
  cveDescription: string;
  cveLink: string;
  cveType: string;
  cveSeverity: string;
  cveCausedByPackage: string;
  cveCausedByPackagePath: string;
  cveFixedIn: string;
  cveCVSSScore: number;
  cveAttackVector: number;
  exploitPoc: string;
  urls: string[] | null;
};

type LoaderDataType = {
  error?: string;
  message?: string;
  data?: CveType;
};
async function getVulnerability(cveId: string) {
  const result = await makeRequest({
    apiFunction: getSearchApiClient().searchVulnerabilities,
    apiArgs: [
      {
        searchSearchNodeReq: {
          node_filter: {
            filters: {
              contains_filter: {
                filter_in: {
                  cve_id: [cveId],
                },
              },
              order_filter: {
                order_field: '',
              },
              match_filter: {
                filter_in: {},
              },
            },
            in_field_filter: null,
          },
          window: {
            offset: 0,
            size: 1,
          },
        },
      },
    ],
    errorHandler: async (r) => {
      const error = new ApiError<LoaderDataType>({
        data: undefined,
      });
      if (r.status === 400) {
        const modelResponse: ApiDocsBadRequestResponse = await r.json();
        return error.set({
          message: modelResponse.message,
          data: undefined,
        });
      }
    },
  });

  if (ApiError.isApiError(result)) {
    throw result.value();
  }

  if (result === null || result.length === 0) {
    return {
      data: undefined,
    };
  }
  const res = result[0];
  return {
    cveId: res.cve_id,
    cveDescription: res.cve_description,
    cveLink: res.cve_link,
    cveType: res.cve_type,
    cveSeverity: res.cve_severity,
    cveCausedByPackage: res.cve_caused_by_package,
    cveCausedByPackagePath: res.cve_caused_by_package_path,
    cveFixedIn: res.cve_fixed_in,
    cveCVSSScore: res.cve_cvss_score,
    cveAttackVector: res.cve_attack_vector,
    exploitPoc: res.exploit_poc,
    urls: res.urls,
  };
}
const loader = async ({
  params,
}: LoaderFunctionArgs): Promise<TypedDeferredData<LoaderDataType>> => {
  const { cveId } = params;

  if (!cveId) {
    throw new Error('Cve Id is required');
  }

  return typedDefer({
    data: getVulnerability(cveId),
  });
};

const Header = () => {
  const loaderData = useLoaderData() as LoaderDataType;

  return (
    <ModalHeader>
      <Suspense fallback={<CircleSpinner size="xs" />}>
        <Await resolve={loaderData.data}>
          {(cve: LoaderDataType['data']) => {
            if (cve === undefined) {
              return (
                <div className="flex items-center p-4 justify-center">
                  <h3 className="text-md text-gray-700 dark:text-gray-400">UNKNOWN</h3>
                </div>
              );
            }
            return (
              <div className="flex flex-col w-full p-4">
                <div className="flex gap-x-2 items-center">
                  <span className="w-5 h-5 text-gray-500 dark:text-white">
                    <VulnerabilityIcon />
                  </span>
                  <span className="text-md text-gray-900 dark:text-white">
                    CVE-2-22-234
                  </span>
                  <Badge
                    label={cve.cveSeverity.toUpperCase()}
                    className={cx({
                      'bg-red-100 dark:bg-red-600/10 text-red-600 dark:text-red-400':
                        cve.cveSeverity.toLowerCase() === 'critical',
                      'bg-pink-100 dark:bg-pink-600/10 text-pink-600 dark:text-pink-400':
                        cve.cveSeverity.toLowerCase() === 'high',
                      'bg-blue-100 dark:bg-blue-600/10 text-blue-600 dark:text-blue-400':
                        cve.cveSeverity.toLowerCase() === 'medium',
                      'bg-yellow-300/20 dark:bg-yellow-400/10 text-yellow-500 dark:text-yellow-400':
                        cve.cveSeverity.toLowerCase() === 'low',
                    })}
                    size="sm"
                  />
                  <CopyToClipboardAsJson text={''} />
                </div>
                <span className="font-normal text-xs text-gray-400 ml-7">
                  Seen 6 months ago
                </span>
              </div>
            );
          }}
        </Await>
      </Suspense>
    </ModalHeader>
  );
};

const DetailsComponent = () => {
  const [openDetails, setOpenDetails] = useState(true);
  const [openTopFiveAttackPath, setOpenTopFiveAttackPath] = useState(true);
  const [showUrls, setShowAllUrls] = useState(false);
  const loaderData = useLoaderData() as LoaderDataType;

  return (
    <div>
      <Suspense fallback={<CircleSpinner size="xs" />}>
        <Await resolve={loaderData.data}>
          {(cve: LoaderDataType['data']) => {
            if (cve === undefined) {
              return (
                <div className="flex items-center p-4 justify-center">
                  <h3 className="text-md text-gray-700 dark:text-gray-400">
                    No vulnerability found
                  </h3>
                </div>
              );
            }
            return (
              <>
                <section>
                  <button
                    className="flex mb-2 font-medium text-xs w-full"
                    onClick={() => {
                      setOpenDetails(!openDetails);
                    }}
                  >
                    <span className="tracking-wider">DETAILS</span>
                    <IconContext.Provider
                      value={{
                        className: cx(
                          'h-4 w-4 text-gray-600 dark:text-gray-200 ml-auto',
                          {
                            'rotate-0': openDetails === true,
                            '-rotate-90': openDetails === false,
                          },
                        ),
                      }}
                    >
                      <HiChevronDown />
                    </IconContext.Provider>
                  </button>
                  {openDetails ? (
                    <>
                      <div className="">
                        <div
                          className={cx(
                            'flex flex-col float-left',
                            'p-2 mr-4 w-fit rounded-lg items-center',
                            {
                              'bg-red-100 dark:bg-red-600/10 text-red-600 dark:text-red-400':
                                cve.cveSeverity.toLowerCase() === 'critical',
                              'bg-pink-100 dark:bg-pink-600/10 text-pink-600 dark:text-pink-400':
                                cve.cveSeverity.toLowerCase() === 'high',
                              'bg-blue-100 dark:bg-blue-600/10 text-blue-600 dark:text-blue-400':
                                cve.cveSeverity.toLowerCase() === 'medium',
                              'bg-yellow-300/20 dark:bg-yellow-400/10 text-yellow-500 dark:text-yellow-400':
                                cve.cveSeverity.toLowerCase() === 'low',
                            },
                          )}
                        >
                          <span className="text-gray-500 dark:text-gray-400 text-xs text-[10px]">
                            CVSS score
                          </span>
                          {cve.cveCVSSScore || 'unknown'}
                        </div>
                        <p className="text-xs pr-2 text-gray-900 dark:text-gray-300 mb-2 text-justify">
                          {cve.cveDescription}
                        </p>
                        <DFLink
                          to={cve.cveLink}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="mt-2 text-xs pr-2 text-blue-600 dark:text-blue-500"
                        >
                          {cve.cveLink}
                        </DFLink>
                      </div>
                      {/* <div className="grid grid-cols-3 gap-2 items-center my-4"></div> */}

                      <div className="grid grid-cols-3 gap-2 items-center my-4 text-xs text-gray-900 dark:text-white">
                        <div className="flex flex-col">
                          <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                            Caused by package
                          </span>
                          <span>{cve.cveCausedByPackage || 'unknown'}</span>
                        </div>

                        <div className="flex flex-col">
                          <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                            Caused by package path
                          </span>
                          <span>{cve.cveCausedByPackagePath || 'unknown'}</span>
                        </div>
                        <div className="flex flex-col">
                          <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                            Fixed in
                          </span>
                          <span>{cve.cveFixedIn || 'unknown'}</span>
                        </div>
                      </div>

                      <div className="flex flex-col gap-y-4 rounded-lg text-xs text-gray-900 dark:text-white">
                        <div className="flex flex-col">
                          <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                            Attack vector
                          </span>
                          <span>{cve.cveAttackVector || 'unknown'}</span>
                        </div>

                        <div className="flex flex-col">
                          <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                            Exploit poc
                          </span>
                          <span>{cve.exploitPoc || 'unknown'}</span>
                        </div>
                        <div className="flex flex-col text-xs text-gray-900 dark:text-white">
                          <button
                            className="text-gray-500 dark:text-gray-400 flex items-center gap-x-2"
                            onClick={() => {
                              setShowAllUrls(!showUrls);
                            }}
                          >
                            <span className="text-[10px]">Urls</span>
                            <IconContext.Provider
                              value={{
                                className: cx(
                                  'cursor-pointer h-2.5 w-2.5 text-gray-500 dark:text-gray-400',
                                  {
                                    'rotate-45': showUrls,
                                  },
                                ),
                              }}
                            >
                              <FaExpandAlt />
                            </IconContext.Provider>
                          </button>
                          {!showUrls ? (
                            <>
                              {!cve.urls ? (
                                'unknown'
                              ) : (
                                <>
                                  <div>[</div>
                                  <div className="pl-4">
                                    {cve?.urls?.[0] || 'unknown'}
                                  </div>
                                  <div className="pl-4">...</div>
                                  <div>]</div>
                                </>
                              )}
                            </>
                          ) : (
                            <>
                              {!cve.urls ? (
                                'unknown'
                              ) : (
                                <>
                                  <div>[</div>
                                  <div className="pl-4">{cve?.urls?.toString()}</div>
                                  <div>]</div>
                                </>
                              )}
                            </>
                          )}
                        </div>
                      </div>
                    </>
                  ) : null}
                </section>
                <section>
                  <button
                    className="flex mb-2 mt-4 font-medium text-xs w-full"
                    onClick={() => {
                      setOpenTopFiveAttackPath(!openTopFiveAttackPath);
                    }}
                  >
                    <span className="tracking-wider">TOP 5 ATTACK PATHS</span>
                    <IconContext.Provider
                      value={{
                        className: cx(
                          'h-4 w-4 text-gray-600 dark:text-gray-200 ml-auto',
                          {
                            'rotate-0': openTopFiveAttackPath === true,
                            '-rotate-90': openTopFiveAttackPath === false,
                          },
                        ),
                      }}
                    >
                      <HiChevronDown />
                    </IconContext.Provider>
                  </button>
                  {openTopFiveAttackPath ? (
                    <div className="min-h-[200px] flex items-center justify-center">
                      <DagreGraphAttackPath />
                    </div>
                  ) : null}
                </section>
              </>
            );
          }}
        </Await>
      </Suspense>
    </div>
  );
};

const VulnerabilityDetails = () => {
  const { goBack } = usePageNavigation();
  return (
    <SlidingModal
      header={<Header />}
      open={true}
      onOpenChange={() => {
        // TODO: change this to navigate
        goBack();
      }}
      width={'w-2/6'}
    >
      <Form className="p-4">
        <DetailsComponent />
      </Form>
    </SlidingModal>
  );
};

export const module = {
  loader,
  element: <VulnerabilityDetails />,
};
