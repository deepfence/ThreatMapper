import cx from 'classnames';
import dayjs from 'dayjs';
import relativeTime from 'dayjs/plugin/relativeTime';
import { omit, pick } from 'lodash-es';
import { Suspense } from 'react';
import { HiExternalLink } from 'react-icons/hi';
import { IconContext } from 'react-icons/lib';
import { LoaderFunctionArgs, useLoaderData, useSearchParams } from 'react-router-dom';
import {
  Badge,
  CircleSpinner,
  SlidingModal,
  SlidingModalCloseButton,
  SlidingModalContent,
  SlidingModalHeader,
} from 'ui-components';

import { getSearchApiClient } from '@/api/api';
import { ApiDocsBadRequestResponse, ModelVulnerability } from '@/api/generated';
import { CopyToClipboard } from '@/components/CopyToClipboard';
import { DFLink } from '@/components/DFLink';
import { VulnerabilityIcon } from '@/components/sideNavigation/icons/Vulnerability';
import { ApiError, makeRequest } from '@/utils/api';
import { typedDefer, TypedDeferredData } from '@/utils/router';
import { DFAwait } from '@/utils/suspense';
import { usePageNavigation } from '@/utils/usePageNavigation';

dayjs.extend(relativeTime);

type LoaderDataType = {
  error?: string;
  message?: string;
  data?: ModelVulnerability;
};
const arrayFields = ['urls'];

async function getVulnerability(cveId: string) {
  const result = await makeRequest({
    apiFunction: getSearchApiClient().searchVulnerabilities,
    apiArgs: [
      {
        searchSearchNodeReq: {
          node_filter: {
            filters: {
              contains_filter: {
                filter_in: {
                  cve_id: [cveId],
                },
              },
              order_filter: {
                order_fields: [],
              },
              match_filter: {
                filter_in: {},
              },
              compare_filter: null,
            },
            in_field_filter: null,
            window: {
              offset: 0,
              size: 0,
            },
          },
          window: {
            offset: 0,
            size: 1,
          },
        },
      },
    ],
    errorHandler: async (r) => {
      const error = new ApiError<LoaderDataType>({
        data: undefined,
      });
      if (r.status === 400) {
        const modelResponse: ApiDocsBadRequestResponse = await r.json();
        return error.set({
          message: modelResponse.message,
          data: undefined,
        });
      }
    },
  });

  if (ApiError.isApiError(result)) {
    throw result.value();
  }

  if (result === null || result.length === 0) {
    return {
      data: undefined,
    };
  }
  return result[0];
}

const loader = async ({
  params,
}: LoaderFunctionArgs): Promise<TypedDeferredData<LoaderDataType>> => {
  const { cveId } = params;

  if (!cveId) {
    throw new Error('Cve Id is required');
  }

  return typedDefer({
    data: getVulnerability(cveId),
  });
};

const Header = () => {
  const loaderData = useLoaderData() as LoaderDataType;

  return (
    <SlidingModalHeader>
      <Suspense fallback={<CircleSpinner size="xs" />}>
        <DFAwait resolve={loaderData.data}>
          {(cve: LoaderDataType['data']) => {
            if (cve === undefined) {
              return (
                <div className="flex items-center p-4 justify-center">
                  <h3 className="text-md text-gray-900 dark:text-gray-400">
                    No details found
                  </h3>
                </div>
              );
            }

            return (
              <div className="flex flex-col w-full">
                <div className="flex gap-x-2 items-center">
                  <span className="w-5 h-5 text-gray-500 dark:text-white">
                    <VulnerabilityIcon />
                  </span>
                  <span className="text-md text-gray-900 dark:text-white">
                    {cve.cve_id}
                  </span>
                  <Badge
                    label={cve.cve_severity.toUpperCase()}
                    className={cx({
                      'bg-[#de425b]/20 dark:bg-[#de425b]/20 text-[#de425b] dark:text-[#de425b]':
                        cve.cve_severity.toLowerCase() === 'critical',
                      'bg-[#f58055]/20 dark:bg-[#f58055/20 text-[#f58055] dark:text-[#f58055]':
                        cve.cve_severity.toLowerCase() === 'high',
                      'bg-[#ffd577]/30 dark:bg-[##ffd577]/10 text-yellow-400 dark:text-[#ffd577]':
                        cve.cve_severity.toLowerCase() === 'medium',
                      'bg-[#d6e184]/20 dark:bg-[#d6e184]/10 text-yellow-300 dark:text-[#d6e184]':
                        cve.cve_severity.toLowerCase() === 'low',
                      'bg-[#9CA3AF]/10 dark:bg-[#9CA3AF]/10 text-gray-400 dark:text-[#9CA3AF]':
                        cve.cve_severity.toLowerCase() === 'unknown',
                    })}
                    size="sm"
                  />
                  <CopyToClipboard data={cve} />
                </div>
                <span className="font-normal text-xs text-gray-500 dark:text-gray-400 ml-7">
                  {dayjs(cve.updated_at).fromNow()}
                </span>
              </div>
            );
          }}
        </DFAwait>
      </Suspense>
    </SlidingModalHeader>
  );
};

const DetailsComponent = () => {
  const loaderData = useLoaderData() as LoaderDataType;

  return (
    <div>
      <Suspense fallback={<CircleSpinner size="xs" />}>
        <DFAwait resolve={loaderData.data}>
          {(cve: LoaderDataType['data']) => {
            if (cve === undefined) {
              return (
                <div className="flex items-center p-4 justify-center">
                  <h3 className="text-md text-gray-900 dark:text-gray-400">
                    No details found
                  </h3>
                </div>
              );
            }
            const pickBy = [
              'cve_id',
              'updated_at',
              'cve_description',
              'cve_link',
              'cve_type',
              'cve_severity',
              'cve_cvss_score',
            ];
            const fixed = pick<ModelVulnerability>(cve, pickBy);
            const others = omit<ModelVulnerability>(cve, pickBy);
            return (
              <div className="text-gray-900 dark:text-gray-300">
                <section>
                  <h3 className="flex mb-2 font-medium text-sm w-full racking-wider dark:text-white">
                    DETAILS
                  </h3>
                  <>
                    <div>
                      <div
                        className={cx(
                          'flex flex-col float-left',
                          'p-2 mr-4 w-fit rounded-lg items-center',
                          {
                            'bg-[#de425b]/20 dark:bg-[#de425b]/20 text-[#de425b] dark:text-[#de425b]':
                              fixed?.cve_severity?.toLowerCase() === 'critical',
                            'bg-[#f58055]/20 dark:bg-[#f58055/20 text-[#f58055] dark:text-[#f58055]':
                              fixed?.cve_severity?.toLowerCase() === 'high',
                            'bg-[#ffd577]/30 dark:bg-[##ffd577]/10 text-yellow-400 dark:text-[#ffd577]':
                              fixed?.cve_severity?.toLowerCase() === 'medium',
                            'bg-[#d6e184]/20 dark:bg-[#d6e184]/10 text-yellow-300 dark:text-[#d6e184]':
                              fixed?.cve_severity?.toLowerCase() === 'low',
                            'bg-[#9CA3AF]/10 dark:bg-[#9CA3AF]/10 text-gray-400 dark:text-[#9CA3AF]':
                              fixed?.cve_severity?.toLowerCase() === 'unknown',
                          },
                        )}
                      >
                        <span className="text-xs text-gray-500">CVSS score</span>
                        <span className="text-md">{fixed.cve_cvss_score || '-'}</span>
                      </div>
                      <p className="text-sm pr-2 mb-2 text-justify">
                        {fixed.cve_description}
                      </p>
                      <DFLink
                        to={fixed.cve_link}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="mt-2 text-sm pr-2 text-blue-600 dark:text-blue-500"
                      >
                        {fixed.cve_link}
                      </DFLink>
                    </div>
                    <div className="mt-6 flex flex-wrap gap-y-4">
                      {Object.keys(others).map((key) => {
                        const label = key.replaceAll('_', ' ').toUpperCase();
                        return (
                          <div
                            key={key}
                            className={'flex flex-col grow basis-1/2 px-2 max-w-full'}
                          >
                            {arrayFields.includes(key) ? (
                              <div className="flex flex-col text-sm">
                                <span className="text-xs text-gray-500">{label}</span>
                                {others &&
                                (others?.[key as keyof typeof cve] as string[])
                                  ?.length === 0 ? (
                                  '-'
                                ) : (
                                  <>
                                    <div className="text-sm">
                                      {others &&
                                        (
                                          others?.[key as keyof typeof cve] as string[]
                                        )?.map((url) => {
                                          return (
                                            <div key={url}>
                                              <DFLink
                                                to={url}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                className="flex gap-x-2 items-center"
                                              >
                                                <div className="truncate">{url}</div>
                                                <IconContext.Provider
                                                  value={{
                                                    className: 'w-4 h-4 shrink-0',
                                                  }}
                                                >
                                                  <HiExternalLink />
                                                </IconContext.Provider>
                                              </DFLink>
                                            </div>
                                          );
                                        })}
                                    </div>
                                  </>
                                )}
                              </div>
                            ) : (
                              <div className="flex flex-col">
                                <span className="text-xs text-gray-500">{label}</span>
                                <span className="text-sm">
                                  {others[key as keyof typeof cve] || '-'}
                                </span>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </>
                </section>
                {/* <section>
                  <h3 className="flex mb-2 mt-6 font-medium text-sm w-full racking-wider dark:text-white">
                    TOP 5 ATTACK PATHS
                  </h3>
                  <div className="min-h-[200px] flex items-center justify-center">
                    <DagreGraphAttackPath />
                  </div>
                </section> */}
              </div>
            );
          }}
        </DFAwait>
      </Suspense>
    </div>
  );
};

const VulnerabilityDetails = () => {
  const { navigate } = usePageNavigation();
  const [searchParams] = useSearchParams();
  return (
    <SlidingModal
      open={true}
      onOpenChange={() => {
        navigate(`..?${searchParams.toString()}`);
      }}
      width={'w-2/6'}
    >
      <SlidingModalCloseButton />
      <Header />
      <SlidingModalContent>
        <DetailsComponent />
      </SlidingModalContent>
    </SlidingModal>
  );
};

export const module = {
  loader,
  element: <VulnerabilityDetails />,
};
