import cx from 'classnames';
import { capitalize, toNumber, truncate } from 'lodash-es';
import { Suspense, useCallback, useMemo, useRef, useState } from 'react';
import { RefObject } from 'react';
import { FaHistory } from 'react-icons/fa';
import { FiFilter } from 'react-icons/fi';
import {
  HiArchive,
  HiArrowSmLeft,
  HiBell,
  HiDotsVertical,
  HiExternalLink,
  HiEye,
  HiEyeOff,
  HiOutlineExclamationCircle,
} from 'react-icons/hi';
import { IconContext } from 'react-icons/lib';
import {
  ActionFunctionArgs,
  Await,
  generatePath,
  LoaderFunctionArgs,
  Outlet,
  useFetcher,
  useLoaderData,
  useSearchParams,
} from 'react-router-dom';
import { Form } from 'react-router-dom';
import { toast } from 'sonner';
import {
  Badge,
  Button,
  Card,
  Checkbox,
  CircleSpinner,
  createColumnHelper,
  Dropdown,
  DropdownItem,
  getRowSelectionColumn,
  IconButton,
  Modal,
  Radio,
  RowSelectionState,
  Select,
  SelectItem,
  Table,
  TableSkeleton,
} from 'ui-components';
import { ModalHeader, SlidingModal } from 'ui-components';

import { getScanResultsApiClient, getVulnerabilityApiClient } from '@/api/api';
import {
  ApiDocsBadRequestResponse,
  ModelScanResultsActionRequestScanTypeEnum,
} from '@/api/generated';
import { DFLink } from '@/components/DFLink';
import { VulnerabilityIcon } from '@/components/sideNavigation/icons/Vulnerability';
import { ApiVulnerableLoaderDataType } from '@/features/vulnerabilities/api/apiLoader';
import { MostExploitableChart } from '@/features/vulnerabilities/components/landing/MostExploitableChart';
import { Mode, useTheme } from '@/theme/ThemeContext';
import { ApiError, makeRequest } from '@/utils/api';
import { formatMilliseconds } from '@/utils/date';
import { typedDefer, TypedDeferredData } from '@/utils/router';
import { usePageNavigation } from '@/utils/usePageNavigation';

export interface FocusableElement {
  focus(options?: FocusOptions): void;
}
enum ActionEnumType {
  MASK = 'mask',
  UNMASK = 'unmask',
  DELETE = 'delete',
  NOTIFY = 'notify',
}
type TableType = {
  cveId: string;
  package: string;
  severity: string;
  description: string;
  link: string;
  masked: boolean;
  action?: null;
};
type ScanResult = {
  totalSeverity: number;
  severityCounts: { [key: string]: number };
  hostName: string;
  nodeType: string;
  nodeId: string;
  timestamp: number;
  tableData: TableType[];
  pagination: {
    currentPage: number;
    totalRows: number;
  };
};

export type LoaderDataType = {
  error?: string;
  message?: string;
  data: ScanResult;
};

const PAGE_SIZE = 50;

const emptyData = {
  totalSeverity: 0,
  severityCounts: {},
  hostName: '',
  nodeType: '',
  nodeId: '',
  timestamp: 0,
  tableData: [],
  pagination: {
    currentPage: 0,
    totalRows: 0,
  },
};

const getSeveritySearch = (searchParams: URLSearchParams) => {
  return searchParams.getAll('severity');
};
const getMaskSearch = (searchParams: URLSearchParams) => {
  return searchParams.getAll('mask');
};
const getUnmaskySearch = (searchParams: URLSearchParams) => {
  return searchParams.getAll('unmask');
};

function getPageFromSearchParams(searchParams: URLSearchParams): number {
  const page = toNumber(searchParams.get('page') ?? '0');
  return isFinite(page) && !isNaN(page) && page > 0 ? page : 0;
}

async function getScans(
  scanId: string,
  searchParams: URLSearchParams,
): Promise<ScanResult> {
  const severity = getSeveritySearch(searchParams);
  const page = getPageFromSearchParams(searchParams);

  const mask = getMaskSearch(searchParams);
  const unmask = getUnmaskySearch(searchParams);
  const filters = {} as {
    cve_severity: string[];
    masked?: boolean[];
  };
  if (severity.length) {
    filters.cve_severity = severity;
  }

  if (mask.length && unmask.length) {
    delete filters.masked;
  } else if (mask.length) {
    filters.masked = [true];
  } else if (unmask.length) {
    filters.masked = [false];
  }
  const filterParams = {
    fields_filter: {
      contains_filter: {
        filter_in: {
          ...filters,
        },
      },
      match_filter: { filter_in: {} },
      order_filter: { order_field: '' },
    },
    scan_id: scanId,
    window: {
      offset: page * PAGE_SIZE,
      size: PAGE_SIZE,
    },
  };

  const result = await makeRequest({
    apiFunction: getVulnerabilityApiClient().resultVulnerabilityScan,
    apiArgs: [
      {
        modelScanResultsReq: filterParams,
      },
    ],
    errorHandler: async (r) => {
      const error = new ApiError<LoaderDataType>({ data: emptyData });
      if (r.status === 400) {
        const modelResponse: ApiDocsBadRequestResponse = await r.json();
        return error.set({
          message: modelResponse.message,
          data: emptyData,
        });
      }
    },
  });

  if (ApiError.isApiError(result)) {
    throw result.value();
  }

  if (result === null) {
    return emptyData;
  }
  const totalSeverity = Object.values(result.severity_counts ?? {}).reduce(
    (acc, value) => {
      acc = acc + value;
      return acc;
    },
    0,
  );

  const vulnerabilities =
    result?.vulnerabilities?.map((res) => {
      return {
        cveId: res.cve_id,
        package: res.cve_caused_by_package,
        severity: res.cve_severity,
        description: res.cve_description,
        link: res.cve_link,
        masked: res.masked,
      };
    }) ?? [];

  const resultCounts = await makeRequest({
    apiFunction: getVulnerabilityApiClient().resultCountVulnerabilityScan,
    apiArgs: [
      {
        modelScanResultsReq: {
          ...filterParams,
          window: {
            ...filterParams.window,
            size: 10 * filterParams.window.size,
          },
        },
      },
    ],
    errorHandler: async (r) => {
      const error = new ApiError<LoaderDataType>({ data: emptyData });
      if (r.status === 400) {
        const modelResponse: ApiDocsBadRequestResponse = await r.json();
        return error.set({
          message: modelResponse.message,
          data: emptyData,
        });
      }
    },
  });

  if (ApiError.isApiError(resultCounts)) {
    throw resultCounts.value();
  }

  return {
    totalSeverity,
    severityCounts: result.severity_counts ?? {},
    hostName: result.host_name,
    nodeType: result.node_type,
    nodeId: result.node_id,
    timestamp: result.updated_at,
    tableData: vulnerabilities,
    pagination: {
      currentPage: page,
      totalRows: page * PAGE_SIZE + resultCounts.count,
    },
  };
}

type ActionFunctionType =
  | ReturnType<typeof getScanResultsApiClient>['deleteScanResult']
  | ReturnType<typeof getScanResultsApiClient>['maskScanResult']
  | ReturnType<typeof getScanResultsApiClient>['notifyScanResult']
  | ReturnType<typeof getScanResultsApiClient>['unmaskScanResult'];

const action = async ({
  params: { scanId = '' },
  request,
}: ActionFunctionArgs): Promise<null> => {
  const formData = await request.formData();
  const cveIds = (formData.getAll('cveIds[]') ?? []) as string[];
  const actionType = formData.get('actionType');
  const _scanId = scanId;
  const mask = formData.get('maskHostAndImages');
  if (!_scanId) {
    throw new Error('Scan ID is required');
  }
  if (!actionType) {
    return null;
  }

  let result = null;
  let apiFunction: ActionFunctionType | null = null;
  if (actionType === ActionEnumType.DELETE || actionType === ActionEnumType.NOTIFY) {
    apiFunction =
      actionType === ActionEnumType.DELETE
        ? getScanResultsApiClient().deleteScanResult
        : getScanResultsApiClient().notifyScanResult;
    result = await makeRequest({
      apiFunction: apiFunction,
      apiArgs: [
        {
          modelScanResultsActionRequest: {
            doc_ids: [...cveIds],
            scan_id: _scanId,
            scan_type: ModelScanResultsActionRequestScanTypeEnum.VulnerabilityScan,
          },
        },
      ],
      errorHandler: async (r) => {
        const error = new ApiError<{
          message?: string;
        }>({});
        if (r.status === 400 || r.status === 409) {
          const modelResponse: ApiDocsBadRequestResponse = await r.json();
          return error.set({
            message: modelResponse.message ?? '',
          });
        }
      },
    });
  } else if (actionType === ActionEnumType.MASK || actionType === ActionEnumType.UNMASK) {
    apiFunction =
      actionType === ActionEnumType.MASK
        ? getScanResultsApiClient().maskScanResult
        : getScanResultsApiClient().unmaskScanResult;
    result = await makeRequest({
      apiFunction: apiFunction,
      apiArgs: [
        {
          modelScanResultsMaskRequest: {
            mask_across_hosts_and_images: mask === 'maskHostAndImages',
            doc_ids: [...cveIds],
            scan_id: _scanId,
            scan_type: ModelScanResultsActionRequestScanTypeEnum.VulnerabilityScan,
          },
        },
      ],
      errorHandler: async (r) => {
        const error = new ApiError<{
          message?: string;
        }>({});
        if (r.status === 400 || r.status === 409) {
          const modelResponse: ApiDocsBadRequestResponse = await r.json();
          return error.set({
            message: modelResponse.message ?? '',
          });
        }
      },
    });
  }

  if (ApiError.isApiError(result)) {
    if (result.value()?.message !== undefined) {
      const message = result.value()?.message ?? 'Something went wrong';
      toast.error(message);
    }
  }

  if (actionType === ActionEnumType.DELETE) {
    toast.success('Deleted successfully');
  } else if (actionType === ActionEnumType.NOTIFY) {
    toast.success('Notified successfully');
  } else if (actionType === ActionEnumType.MASK) {
    toast.success('Masked successfully');
  } else if (actionType === ActionEnumType.UNMASK) {
    toast.success('Unmasked successfully');
  }
  return null;
};

const loader = async ({
  params,
  request,
}: LoaderFunctionArgs): Promise<TypedDeferredData<LoaderDataType>> => {
  const scanId = params?.scanId ?? '';

  const searchParams = new URL(request.url).searchParams;

  return typedDefer({
    data: getScans(scanId, searchParams),
  });
};

const FilterHeader = () => {
  return (
    <ModalHeader>
      <div className="flex gap-x-2 items-center p-4">
        <span className="font-medium text-lg">Filters</span>
      </div>
    </ModalHeader>
  );
};

const ScanResultFilterModal = ({
  showFilter,
  elementToFocusOnClose,
  setShowFilter,
}: {
  elementToFocusOnClose: RefObject<FocusableElement> | null;
  showFilter: boolean;
  setShowFilter: React.Dispatch<React.SetStateAction<boolean>>;
}) => {
  const [searchParams, setSearchParams] = useSearchParams();
  return (
    <SlidingModal
      header={<FilterHeader />}
      open={showFilter}
      onOpenChange={() => setShowFilter(false)}
      elementToFocusOnCloseRef={elementToFocusOnClose}
      width={'w-[350px]'}
    >
      <div className="dark:text-white p-4">
        <div className="flex flex-col gap-y-6">
          <fieldset>
            <legend className="text-sm font-medium">Mask And Unmask</legend>
            <div className="flex gap-x-4 mt-1">
              <Checkbox
                label="Mask"
                checked={searchParams.getAll('mask').includes('true')}
                onCheckedChange={(state) => {
                  if (state) {
                    setSearchParams((prev) => {
                      prev.append('mask', 'true');
                      prev.delete('page');
                      return prev;
                    });
                  } else {
                    setSearchParams((prev) => {
                      const prevStatuses = prev.getAll('mask');
                      prev.delete('mask');
                      prevStatuses
                        .filter((mask) => mask !== 'true')
                        .forEach((mask) => {
                          prev.append('mask', mask);
                        });
                      prev.delete('mask');
                      prev.delete('page');
                      return prev;
                    });
                  }
                }}
              />
              <Checkbox
                label="Unmask"
                checked={searchParams.getAll('unmask').includes('true')}
                onCheckedChange={(state) => {
                  if (state) {
                    setSearchParams((prev) => {
                      prev.append('unmask', 'true');
                      prev.delete('page');
                      return prev;
                    });
                  } else {
                    setSearchParams((prev) => {
                      const prevStatuses = prev.getAll('unmask');
                      prev.delete('unmask');
                      prevStatuses
                        .filter((status) => status !== 'true')
                        .forEach((status) => {
                          prev.append('unmask', status);
                        });
                      prev.delete('unmask');
                      prev.delete('page');
                      return prev;
                    });
                  }
                }}
              />
            </div>
          </fieldset>
          <fieldset>
            <Select
              noPortal
              name="severity"
              label={'Severity'}
              placeholder="Select Severity"
              value={searchParams.getAll('severity')}
              sizing="xs"
              onChange={(value) => {
                setSearchParams((prev) => {
                  prev.delete('severity');
                  value.forEach((language) => {
                    prev.append('severity', language);
                  });
                  prev.delete('page');
                  return prev;
                });
              }}
            >
              {['critical', 'high', 'medium', 'low', 'unknown'].map(
                (severity: string) => {
                  return (
                    <SelectItem value={severity} key={severity}>
                      {capitalize(severity)}
                    </SelectItem>
                  );
                },
              )}
            </Select>
          </fieldset>
        </div>
      </div>
    </SlidingModal>
  );
};
const DeleteConfirmationModal = ({
  showDialog,
  ids,
  setShowDialog,
}: {
  showDialog: boolean;
  ids: string[];
  setShowDialog: React.Dispatch<React.SetStateAction<boolean>>;
}) => {
  const fetcher = useFetcher();

  const onDeleteAction = useCallback(
    (actionType: string) => {
      const formData = new FormData();
      formData.append('actionType', actionType);
      ids.forEach((item) => formData.append('cveIds[]', item));
      fetcher.submit(formData, {
        method: 'post',
      });
    },
    [ids, fetcher],
  );

  return (
    <Modal open={showDialog} onOpenChange={() => setShowDialog(false)}>
      <div className="grid place-items-center">
        <IconContext.Provider
          value={{
            className: 'mb-3 dark:text-red-600 text-red-400 w-[70px] h-[70px]',
          }}
        >
          <HiOutlineExclamationCircle />
        </IconContext.Provider>
        <h3 className="mb-4 font-normal text-center text-sm">
          The selected vulnerabilities will be deleted.
          <br />
          <span>Are you sure you want to delete?</span>
        </h3>
        <div className="flex items-center justify-right gap-4">
          <Button size="xs" onClick={() => setShowDialog(false)}>
            No, cancel
          </Button>
          <Button
            size="xs"
            color="danger"
            onClick={() => {
              onDeleteAction(ActionEnumType.DELETE);
              setShowDialog(false);
            }}
          >
            Yes, I&apos;m sure
          </Button>
        </div>
      </div>
    </Modal>
  );
};
const MaskTypeSelectionModal = ({
  showDialog,
  ids,
  type,
  setMask,
}: {
  showDialog: boolean;
  ids: string[];
  type: string;
  setMask: React.Dispatch<
    React.SetStateAction<{
      show: boolean;
      type: string;
    }>
  >;
}) => {
  const fetcher = useFetcher();
  const [option, setOption] = useState('');
  const onMaskAction = (maskHostAndImages: string) => {
    const formData = new FormData();
    formData.append('actionType', type);
    formData.append('maskHostAndImages', maskHostAndImages);
    ids.forEach((item) => formData.append('cveIds[]', item));
    fetcher.submit(formData, {
      method: 'post',
    });
  };

  return (
    <Modal
      open={showDialog}
      onOpenChange={() =>
        setMask({
          show: false,
          type: '',
        })
      }
    >
      <div className="grid place-items-center">
        <IconContext.Provider
          value={{
            className: 'mb-3 dark:text-gray-400 text-gray-700 w-[70px] h-[70px]',
          }}
        >
          {type === ActionEnumType.MASK ? <HiEyeOff /> : <HiEye />}
        </IconContext.Provider>

        <h3 className="mb-3 font-normal">Select your {type} option</h3>
        <Radio
          name="mask"
          options={[
            {
              label: `${capitalize(type)} this vulnerability`,
              value: 'thisVulnerability',
            },
            {
              label: `${capitalize(type)} this vulnerability across host and images`,
              value: 'maskHostAndImages',
            },
          ]}
          onValueChange={(value) => {
            setOption(value);
          }}
        />
        <div className="mt-4 flex items-center justify-right gap-4">
          <Button
            size="xs"
            onClick={() =>
              setMask({
                show: false,
                type: '',
              })
            }
          >
            Cancel
          </Button>
          <Button
            size="xs"
            color="primary"
            onClick={() => {
              onMaskAction(option);
              setMask({
                show: false,
                type: '',
              });
            }}
          >
            Submit
          </Button>
        </div>
      </div>
    </Modal>
  );
};
const HistoryDropdown = () => {
  const { navigate } = usePageNavigation();
  const fetcher = useFetcher<ApiVulnerableLoaderDataType>();
  const loaderData = useLoaderData() as LoaderDataType;
  const isScanHistoryLoading = fetcher.state === 'loading';

  const onHistoryClick = (nodeType: string, nodeId: string) => {
    fetcher.load(
      generatePath('/_api/vulnerability/scan-results/history/:nodeType/:nodeId', {
        nodeId: nodeId,
        nodeType: nodeType,
      }),
    );
  };

  return (
    <Suspense
      fallback={
        <IconButton
          size="xs"
          color="primary"
          outline
          className="rounded-lg bg-transparent"
          icon={<FaHistory />}
          type="button"
          loading
        />
      }
    >
      <Await resolve={loaderData.data ?? []}>
        {(resolvedData: LoaderDataType['data']) => {
          return (
            <Dropdown
              triggerAsChild
              onOpenChange={(open) => {
                if (open) onHistoryClick(resolvedData.nodeType, resolvedData.nodeId);
              }}
              content={
                <>
                  {fetcher?.data?.data?.map((item) => {
                    return (
                      <DropdownItem
                        className="text-sm"
                        key={item.scanId}
                        onClick={() => {
                          navigate(
                            generatePath('/vulnerability/scan-results/:scanId', {
                              scanId: item.scanId,
                            }),
                            {
                              replace: true,
                            },
                          );
                        }}
                      >
                        <span className="flex items-center text-gray-700 dark:text-gray-400">
                          {formatMilliseconds(item.updatedAt)}
                        </span>
                      </DropdownItem>
                    );
                  })}
                </>
              }
            >
              <IconButton
                size="xs"
                color="primary"
                outline
                className="rounded-lg bg-transparent"
                icon={<FaHistory />}
                type="button"
                loading={isScanHistoryLoading}
              />
            </Dropdown>
          );
        }}
      </Await>
    </Suspense>
  );
};
const MaskDropdown = ({ ids }: { ids: string[] }) => {
  const fetcher = useFetcher();

  const onMaskAction = useCallback(
    (maskHostAndImages: string) => {
      const formData = new FormData();
      formData.append('actionType', ActionEnumType.MASK);
      formData.append('maskHostAndImages', maskHostAndImages);
      ids.forEach((item) => formData.append('cveIds[]', item));
      fetcher.submit(formData, {
        method: 'post',
      });
    },
    [ids, fetcher],
  );

  return (
    <Dropdown
      triggerAsChild={true}
      content={
        <>
          <DropdownItem className="text-sm" onClick={() => onMaskAction('')}>
            <span className="flex items-center gap-x-2 text-gray-700 dark:text-gray-400">
              <IconContext.Provider
                value={{ className: 'text-gray-700 dark:text-gray-400' }}
              >
                <HiEyeOff />
              </IconContext.Provider>
              Mask this vulnerability
            </span>
          </DropdownItem>
          <DropdownItem
            className="text-sm"
            onClick={() => onMaskAction('maskHostAndImages')}
          >
            <span className="flex items-center gap-x-2 text-gray-700 dark:text-gray-400">
              <IconContext.Provider
                value={{ className: 'text-gray-700 dark:text-gray-400' }}
              >
                <HiEyeOff />
              </IconContext.Provider>
              Mask this vulnerability across host and images
            </span>
          </DropdownItem>
        </>
      }
    >
      <Button size="xs" color="default" outline startIcon={<HiEyeOff />} type="button">
        Mask
      </Button>
    </Dropdown>
  );
};
const UnMaskDropdown = ({ ids }: { ids: string[] }) => {
  const fetcher = useFetcher();

  const onUnMaskAction = useCallback(
    (unMaskHostAndImages: string) => {
      const formData = new FormData();
      formData.append('actionType', ActionEnumType.UNMASK);
      formData.append('maskHostAndImages', unMaskHostAndImages);
      ids.forEach((item) => formData.append('cveIds[]', item));
      fetcher.submit(formData, {
        method: 'post',
      });
    },
    [ids],
  );

  return (
    <Dropdown
      triggerAsChild={true}
      content={
        <>
          <DropdownItem className="text-sm" onClick={() => onUnMaskAction('')}>
            <span className="flex items-center gap-x-2 text-gray-700 dark:text-gray-400">
              <IconContext.Provider
                value={{ className: 'text-gray-700 dark:text-gray-400' }}
              >
                <HiEye />
              </IconContext.Provider>
              Unmask this vulnerability
            </span>
          </DropdownItem>
          <DropdownItem
            className="text-sm"
            onClick={() => onUnMaskAction('maskHostAndImages')}
          >
            <span className="flex items-center gap-x-2 text-gray-700 dark:text-gray-400">
              <IconContext.Provider
                value={{ className: 'text-gray-700 dark:text-gray-400' }}
              >
                <HiEye />
              </IconContext.Provider>
              Unmask this vulnerability across host and images
            </span>
          </DropdownItem>
        </>
      }
    >
      <Button size="xs" color="default" outline startIcon={<HiEye />} type="button">
        Un mask
      </Button>
    </Dropdown>
  );
};
const ActionDropdown = ({
  icon,
  ids,
  label,
}: {
  icon: React.ReactNode;
  ids: string[];
  label?: string;
}) => {
  const fetcher = useFetcher();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  const [mask, setMask] = useState({
    show: false,
    type: '',
  });

  const onTableAction = useCallback(
    (actionType: string) => {
      const formData = new FormData();
      formData.append('actionType', actionType);
      ids.forEach((item) => formData.append('cveIds[]', item));
      fetcher.submit(formData, {
        method: 'post',
      });
    },
    [ids],
  );

  return (
    <>
      <MaskTypeSelectionModal
        showDialog={mask.show}
        setMask={setMask}
        ids={ids}
        type={mask.type}
      />
      <DeleteConfirmationModal
        showDialog={showDeleteDialog}
        ids={ids}
        setShowDialog={setShowDeleteDialog}
      />
      <Dropdown
        triggerAsChild={true}
        align="end"
        content={
          <>
            <DropdownItem
              className="text-sm"
              onClick={() =>
                setMask({
                  show: true,
                  type: ActionEnumType.MASK,
                })
              }
            >
              <span className="flex items-center gap-x-2 text-gray-700 dark:text-gray-400">
                <IconContext.Provider
                  value={{ className: 'text-gray-700 dark:text-gray-400' }}
                >
                  <HiEyeOff />
                </IconContext.Provider>
                Mask
              </span>
            </DropdownItem>
            <DropdownItem
              className="text-sm"
              onClick={() =>
                setMask({
                  show: true,
                  type: ActionEnumType.UNMASK,
                })
              }
            >
              <span className="flex items-center gap-x-2 text-gray-700 dark:text-gray-400">
                <IconContext.Provider
                  value={{ className: 'text-gray-700 dark:text-gray-400' }}
                >
                  <HiEye />
                </IconContext.Provider>
                Un Mask
              </span>
            </DropdownItem>
            <DropdownItem
              className="text-sm"
              onClick={() => onTableAction(ActionEnumType.NOTIFY)}
            >
              <span className="flex items-center gap-x-2 text-gray-700 dark:text-gray-400">
                <IconContext.Provider
                  value={{ className: 'text-gray-700 dark:text-gray-400' }}
                >
                  <HiBell />
                </IconContext.Provider>
                Notify
              </span>
            </DropdownItem>
            <DropdownItem
              className="text-sm"
              onClick={() => {
                setShowDeleteDialog(true);
              }}
            >
              <span className="flex items-center gap-x-2 text-red-700 dark:text-red-400">
                <IconContext.Provider
                  value={{ className: 'text-red-700 dark:text-red-400' }}
                >
                  <HiArchive />
                </IconContext.Provider>
                Delete
              </span>
            </DropdownItem>
          </>
        }
      >
        <Button size="xs" color="normal" className="hover:bg-transparent">
          <IconContext.Provider value={{ className: 'text-gray-700 dark:text-gray-400' }}>
            {icon}
          </IconContext.Provider>
          {label ? <span className="ml-2">{label}</span> : null}
        </Button>
      </Dropdown>
    </>
  );
};
const CVETable = () => {
  const fetcher = useFetcher();
  const loaderData = useLoaderData() as LoaderDataType;
  const columnHelper = createColumnHelper<TableType>();
  const [searchParams, setSearchParams] = useSearchParams();
  const [rowSelectionState, setRowSelectionState] = useState<RowSelectionState>({});
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  const columns = useMemo(() => {
    const columns = [
      getRowSelectionColumn(columnHelper, {
        size: 0,
        minSize: 0,
        maxSize: 0,
      }),

      columnHelper.accessor('cveId', {
        enableSorting: false,
        cell: (info) => (
          <DFLink
            to={{
              pathname: `./${info.getValue()}`,
              search: searchParams.toString(),
            }}
            className="flex items-center gap-x-2"
          >
            <>
              <div className="p-1.5 bg-gray-100 dark:bg-gray-500/10 rounded-lg">
                <div className="w-4 h-4">
                  <VulnerabilityIcon />
                </div>
              </div>
              {info.getValue()}
            </>
          </DFLink>
        ),
        header: () => 'CVE ID',
        minSize: 200,
        size: 200,
        maxSize: 250,
      }),
      columnHelper.accessor('package', {
        enableSorting: true,
        cell: (info) => info.getValue(),
        header: () => 'Package',
        minSize: 100,
        size: 250,
        maxSize: 250,
      }),
      columnHelper.accessor('severity', {
        enableSorting: false,
        cell: (info) => (
          <Badge
            label={info.getValue().toUpperCase()}
            className={cx({
              'bg-red-100 dark:bg-red-600/10 text-red-600 dark:text-red-400':
                info.getValue().toLowerCase() === 'critical',
              'bg-pink-100 dark:bg-pink-600/10 text-pink-600 dark:text-pink-400':
                info.getValue().toLowerCase() === 'high',
              'bg-blue-100 dark:bg-blue-600/10 text-blue-600 dark:text-blue-400':
                info.getValue().toLowerCase() === 'medium',
              'bg-yellow-300/20 dark:bg-yellow-400/10 text-yellow-500 dark:text-yellow-400':
                info.getValue().toLowerCase() === 'low',
            })}
            size="sm"
          />
        ),
        header: () => 'Severity',
        minSize: 60,
        size: 80,
        maxSize: 80,
      }),
      columnHelper.accessor('description', {
        enableSorting: false,
        cell: (info) => {
          return (
            <div className="max-w-full truncate">
              {truncate(info.getValue(), {
                length: 60,
              }) ?? 'No Description Available'}
            </div>
          );
        },
        header: () => 'Description',
        minSize: 300,
        size: 400,
        maxSize: 400,
      }),
      columnHelper.accessor('link', {
        enableSorting: false,
        cell: (info) => (
          <DFLink to={info.getValue()} target="_blank" rel="noopener noreferrer">
            <IconContext.Provider
              value={{
                className: 'w-4 h-4',
              }}
            >
              <HiExternalLink />
            </IconContext.Provider>
          </DFLink>
        ),
        header: () => 'Link',
        minSize: 30,
        size: 50,
        maxSize: 50,
      }),
      columnHelper.accessor('action', {
        id: 'actions',
        enableSorting: false,
        cell: (cell) => (
          <ActionDropdown icon={<HiDotsVertical />} ids={[cell.row.original.cveId]} />
        ),
        header: () => '',
        minSize: 10,
        size: 10,
        maxSize: 10,
      }),
    ];

    return columns;
  }, [setSearchParams]);

  const onTableAction = useCallback(
    (actionType: string) => {
      const formData = new FormData();
      formData.append('actionType', actionType);
      Object.keys(rowSelectionState).forEach((item) => formData.append('cveIds[]', item));
      fetcher.submit(formData, {
        method: 'post',
      });
    },
    [rowSelectionState],
  );

  return (
    <>
      <Suspense fallback={<TableSkeleton columns={10} rows={10} size={'md'} />}>
        <Await resolve={loaderData.data}>
          {(resolvedData: LoaderDataType['data']) => {
            return (
              <Form>
                {Object.keys(rowSelectionState).length === 0 ? (
                  <div className="text-sm text-gray-400 font-medium py-2.5">
                    No rows selected
                  </div>
                ) : (
                  <>
                    <DeleteConfirmationModal
                      showDialog={showDeleteDialog}
                      ids={Object.keys(rowSelectionState)}
                      setShowDialog={setShowDeleteDialog}
                    />
                    <div className="mb-2 flex gap-x-2">
                      <Button
                        size="xs"
                        color="danger"
                        outline
                        startIcon={<HiArchive />}
                        onClick={() => setShowDeleteDialog(true)}
                      >
                        Delete
                      </Button>
                      <MaskDropdown ids={Object.keys(rowSelectionState)} />
                      <UnMaskDropdown ids={Object.keys(rowSelectionState)} />
                      <Button
                        size="xs"
                        color="default"
                        outline
                        startIcon={<HiBell />}
                        onClick={() => onTableAction(ActionEnumType.NOTIFY)}
                      >
                        Notify
                      </Button>
                    </div>
                  </>
                )}

                <Table
                  size="sm"
                  data={resolvedData.tableData}
                  columns={columns}
                  enableRowSelection
                  rowSelectionState={rowSelectionState}
                  onRowSelectionChange={setRowSelectionState}
                  enableSorting
                  enablePagination
                  manualPagination
                  totalRows={resolvedData.pagination.totalRows}
                  pageSize={PAGE_SIZE}
                  pageIndex={resolvedData.pagination.currentPage}
                  getRowId={(row) => row.cveId}
                  onPaginationChange={(updaterOrValue) => {
                    let newPageIndex = 0;
                    if (typeof updaterOrValue === 'function') {
                      newPageIndex = updaterOrValue({
                        pageIndex: resolvedData.pagination.currentPage,
                        pageSize: PAGE_SIZE,
                      }).pageIndex;
                    } else {
                      newPageIndex = updaterOrValue.pageIndex;
                    }
                    setSearchParams((prev) => {
                      prev.set('page', String(newPageIndex));
                      return prev;
                    });
                  }}
                  getTrProps={(row) => {
                    if (row.original.masked) {
                      return {
                        className: 'opacity-40',
                      };
                    }
                    return {};
                  }}
                />
              </Form>
            );
          }}
        </Await>
      </Suspense>
    </>
  );
};

const HeaderComponent = ({
  elementToFocusOnClose,
  setShowFilter,
}: {
  elementToFocusOnClose: React.MutableRefObject<null>;
  setShowFilter: React.Dispatch<React.SetStateAction<boolean>>;
}) => {
  const [searchParams] = useSearchParams();
  const loaderData = useLoaderData() as LoaderDataType;
  const isFilterApplied =
    searchParams.has('severity') ||
    searchParams.has('mask') ||
    searchParams.has('unmask');

  return (
    <div className="flex p-1 pl-2 w-full items-center shadow bg-white dark:bg-gray-800">
      <Suspense fallback={<CircleSpinner size="xs" />}>
        <Await resolve={loaderData.data ?? []}>
          {(resolvedData: LoaderDataType['data']) => {
            const { nodeType, hostName } = resolvedData;
            return (
              <>
                <DFLink
                  to={`/vulnerability/scans?nodeType=${nodeType}`}
                  className="flex hover:no-underline items-center justify-center  mr-2"
                >
                  <IconContext.Provider
                    value={{
                      className: 'w-5 h-5 text-blue-600 dark:text-blue-500 ',
                    }}
                  >
                    <HiArrowSmLeft />
                  </IconContext.Provider>
                </DFLink>
                <span className="text-sm font-medium text-gray-700 dark:text-gray-200">
                  VULNERABILITY SCAN RESULTS - {nodeType} / {hostName}
                </span>
              </>
            );
          }}
        </Await>
      </Suspense>
      <div className="ml-auto flex items-center gap-x-4">
        <div className="flex flex-col">
          <span className="text-xs text-gray-500 dark:text-gray-200">
            <Suspense fallback={<CircleSpinner size="xs" />}>
              <Await resolve={loaderData.data ?? []}>
                {(resolvedData: LoaderDataType['data']) => {
                  const { timestamp } = resolvedData;
                  return formatMilliseconds(timestamp);
                }}
              </Await>
            </Suspense>
          </span>
          <span className="text-gray-400 text-[10px]">Last scan</span>
        </div>
        <div className="ml-auto">
          <HistoryDropdown />
        </div>

        <div className="relative">
          {isFilterApplied && (
            <span className="absolute left-0 top-0 inline-flex h-2 w-2 rounded-full bg-blue-400 opacity-75"></span>
          )}
          <div className="ml-auto">
            <IconButton
              size="xs"
              outline
              color="primary"
              className="rounded-lg bg-transparent"
              onClick={() => setShowFilter(true)}
              icon={<FiFilter />}
            />
          </div>
        </div>
      </div>
    </div>
  );
};
const SeverityCountComponent = ({ theme }: { theme: Mode }) => {
  const loaderData = useLoaderData() as LoaderDataType;
  return (
    <Card className="p-4 grid grid-flow-row-dense gap-y-8">
      <Suspense
        fallback={
          <div className="min-h-[300px] flex items-center justify-center">
            <CircleSpinner size="md" />
          </div>
        }
      >
        <Await resolve={loaderData.data}>
          {(resolvedData: ScanResult) => {
            const { totalSeverity, severityCounts } = resolvedData;
            return (
              <>
                <div className="grid grid-flow-col-dense gap-x-4">
                  <div className="bg-red-100 dark:bg-red-500/10 rounded-lg flex items-center justify-center">
                    <div className="w-14 h-14 text-red-500 dark:text-red-400">
                      <VulnerabilityIcon />
                    </div>
                  </div>
                  <div>
                    <h4 className="text-md font-semibold text-gray-900 dark:text-gray-200 tracking-wider">
                      Total vulnerabilities
                    </h4>
                    <div className="mt-2">
                      <span className="text-2xl text-gray-900 dark:text-gray-200">
                        {totalSeverity}
                      </span>
                      <h5 className="text-xs text-gray-500 dark:text-gray-200 mb-2">
                        Total count
                      </h5>
                      <div>
                        <span className="text-sm text-gray-900 dark:text-gray-200">
                          {0}
                        </span>
                        <span className="ml-2 text-xs text-gray-500 dark:text-gray-400">
                          Active containers
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
                <div className="min-h-[220px]">
                  <MostExploitableChart theme={theme} data={severityCounts} />
                </div>
                <div>
                  {Object.keys(severityCounts)?.map((key: string) => {
                    return (
                      <div key={key} className="flex items-center gap-2 p-1">
                        <div
                          className={cx('h-3 w-3 rounded-full', {
                            'bg-red-400 dark:bg-red-500':
                              key.toLowerCase() === 'critical',
                            'bg-pink-400 dark:bg-pink-500': key.toLowerCase() === 'high',
                            'bg-blue-400 dark:bg-blue-500':
                              key.toLowerCase() === 'medium',
                            'bg-yellow-400 dark:bg-yellow-500':
                              key.toLowerCase() === 'low',
                          })}
                        />
                        <span className="text-sm text-gray-500 dark:text-gray-200">
                          {capitalize(key)}
                        </span>
                        <span
                          className={cx(
                            'text-sm text-gray-900 dark:text-gray-200 ml-auto',
                          )}
                        >
                          {severityCounts[key]}
                        </span>
                      </div>
                    );
                  })}
                </div>
              </>
            );
          }}
        </Await>
      </Suspense>
    </Card>
  );
};
const VulnerabilityScanResults = () => {
  const elementToFocusOnClose = useRef(null);
  const [showFilter, setShowFilter] = useState(false);
  const { mode } = useTheme();

  return (
    <>
      <ScanResultFilterModal
        showFilter={showFilter}
        setShowFilter={setShowFilter}
        elementToFocusOnClose={elementToFocusOnClose.current}
      />
      <HeaderComponent
        elementToFocusOnClose={elementToFocusOnClose}
        setShowFilter={setShowFilter}
      />
      <div className="grid grid-cols-[400px_1fr] p-2 gap-x-2">
        <div className="self-start grid gap-y-2">
          <SeverityCountComponent theme={mode} />
        </div>
        <CVETable />
      </div>
      <Outlet />
    </>
  );
};

export const module = {
  loader,
  action,
  element: <VulnerabilityScanResults />,
};
