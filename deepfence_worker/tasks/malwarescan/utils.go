package malwarescan

import (
	"context"
	"encoding/json"
	"fmt"
	"time"

	"github.com/deepfence/ThreatMapper/deepfence_utils/log"
	"github.com/deepfence/ThreatMapper/deepfence_utils/utils"
	"github.com/deepfence/YaraHunter/pkg/scan"
	"github.com/twmb/franz-go/pkg/kgo"
)

type MalwareScanStatus struct {
	utils.MalwareScanParameters
	ScanStatus  string `json:"scan_status,omitempty"`
	ScanMessage string `json:"scan_message,omitempty"`
}

func NewMalwareScanStatus(params utils.MalwareScanParameters, Status string, msg string) MalwareScanStatus {
	return MalwareScanStatus{MalwareScanParameters: params, ScanStatus: Status, ScanMessage: msg}
}

func SendScanStatus(ingestC chan *kgo.Record, status MalwareScanStatus, rh []kgo.RecordHeader) error {
	sb, err := json.Marshal(status)
	if err != nil {
		log.Error().Msg(err.Error())
		return err
	} else {
		ingestC <- &kgo.Record{
			Topic:   utils.MALWARE_SCAN_STATUS,
			Value:   sb,
			Headers: rh,
		}
	}
	return nil
}

func StartStatusReporter(ctx context.Context, scanner *scan.Scanner,
	params utils.MalwareScanParameters, ingestC chan *kgo.Record,
	rh []kgo.RecordHeader) chan error {

	res := make(chan error)
	scan_id := scanner.ScanID

	//If we don't get any active status back within threshold,
	//we consider the scan job as dead
	threshold := 600
	go func() {
		ticker := time.NewTicker(1 * time.Second)
		var err error
		ts := time.Now()
		var counter uint64
		log.Info().Msgf("StatusReporter started, scan_id: %s", scan_id)
	loop:
		for {
			select {
			case err = <-res:
				break loop
			case <-ctx.Done():
				err = ctx.Err()
				break loop
			case <-scanner.ScanStatusChan:
				ts = time.Now()
			case <-ticker.C:
				if scanner.Stopped.Load() == true {
					log.Info().Msgf("Scanner job stopped, Scan id: %s", scan_id)
					break loop
				}

				counter++

				//We perform the check once per 30 seconds
				if counter%30 != 0 {
					continue
				}

				elapsed := int(time.Since(ts).Seconds())
				if elapsed > threshold {
					err = fmt.Errorf("Scan job aborted due to inactivity")
					log.Error().Msgf("Scanner job aborted due to inactivity, scan_id: %s", scan_id)

					scanner.Aborted.Store(true)
					break loop
				} else {
					SendScanStatus(ingestC, NewMalwareScanStatus(params,
						utils.SCAN_STATUS_INPROGRESS, ""), rh)
				}
			}
		}

		if scanner.Stopped.Load() == true {
			SendScanStatus(ingestC, NewMalwareScanStatus(params,
				utils.SCAN_STATUS_CANCELLED, "Scan stopped by user"), rh)
		} else if err != nil {
			SendScanStatus(ingestC, NewMalwareScanStatus(params,
				utils.SCAN_STATUS_FAILED, err.Error()), rh)
		} else {
			SendScanStatus(ingestC, NewMalwareScanStatus(params,
				utils.SCAN_STATUS_SUCCESS, ""), rh)
		}

		log.Info().Msgf("StatusReporter finished, scan_id: %s", scan_id)
	}()

	return res
}
